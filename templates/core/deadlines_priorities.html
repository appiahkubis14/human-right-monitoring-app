{% extends 'base/web_base.html' %}
{% load static %}

{% block content %}
<div class="page-content">
    <div class="page-container">
        <br>
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div class="mb-3">
                            <div>
                                <h4 style="font-weight: bolder;">SET DEADLINES & PRIORITIES</h4>
                                <p class="mb-0">Manage deadlines and priorities for staff and enumerators</p>
                            </div>
                        </div>
                        <button class="btn btn-gradient-primary btn-sm" id="addDeadlineBtn">
                            <i class="fas fa-plus"></i> NEW DEADLINE
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-outline-primary filter-btn active" data-filter="all">
                                        All Deadlines
                                    </button>
                                    <button type="button" class="btn btn-outline-primary filter-btn" data-filter="pending">
                                        Pending
                                    </button>
                                    <button type="button" class="btn btn-outline-primary filter-btn" data-filter="in_progress">
                                        In Progress
                                    </button>
                                    <button type="button" class="btn btn-outline-primary filter-btn" data-filter="completed">
                                        Completed
                                    </button>
                                    <button type="button" class="btn btn-outline-primary filter-btn" data-filter="overdue">
                                        Overdue
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table id="deadlinesTable" class="table table-striped table-bordered" style="width:100%">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>TITLE</th>
                                        <th>ASSIGNED TO</th>
                                        <th>TYPE</th>
                                        <th>PRIORITY</th>
                                        <th>START DATE</th>
                                        <th>END DATE</th>
                                        <th>DAYS LEFT</th>
                                        <th>STATUS</th>
                                        <th>ASSIGNED BY</th>
                                        <th>ACTIONS</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Data will be loaded via AJAX -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add/Edit Modal -->
        <div class="modal fade" id="deadlineModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header text-white bg-primary">
                        <h5 class="modal-title" id="modalTitle">New Deadline</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <form id="deadlineForm" class="needs-validation" novalidate>
                        {% csrf_token %}
                        <input type="hidden" id="deadlineId" name="deadlineId">
                        <div class="modal-body">
                            <div class="row mb-3">
                                <div class="col-md-8">
                                    <div class="form-group">
                                        <label for="title" class="form-label">Title*</label>
                                        <input type="text" class="form-control" id="title" name="title" required>
                                        <div class="invalid-feedback">Please enter a title</div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="staff_type" class="form-label">Staff Type*</label>
                                        <select class="form-select" id="staff_type" name="staff_type" required>
                                            <option value="Staff">Staff</option>
                                            <option value="Enumerator">Enumerator</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-12">
                                    <div class="form-group">
                                        <label for="description" class="form-label">Description</label>
                                        <textarea class="form-control" id="description" name="description" rows="3"></textarea>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="deadline_type_id" class="form-label">Deadline Type*</label>
                                        <select class="form-select select2-single" id="deadline_type_id" name="deadline_type_id" required>
                                            <option value="" selected disabled>Select Type</option>
                                            <!-- Options will be loaded via AJAX -->
                                        </select>
                                        <div class="invalid-feedback">Please select deadline type</div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="priority_level_id" class="form-label">Priority Level*</label>
                                        <select class="form-select select2-single" id="priority_level_id" name="priority_level_id" required>
                                            <option value="" selected disabled>Select Priority</option>
                                            <!-- Options will be loaded via AJAX -->
                                        </select>
                                        <div class="invalid-feedback">Please select priority level</div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="assigned_to_id" class="form-label">Assign To*</label>
                                        <select class="form-select select2-single" id="assigned_to_id" name="assigned_to_id" required>
                                            <option value="" selected disabled>Select Staff</option>
                                            <!-- Options will be loaded via AJAX -->
                                        </select>
                                        <div class="invalid-feedback">Please select staff member</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="start_date" class="form-label">Start Date*</label>
                                        <input type="datetime-local" class="form-control" id="start_date" name="start_date" required>
                                        <div class="invalid-feedback">Please select start date</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="end_date" class="form-label">End Date*</label>
                                        <input type="datetime-local" class="form-control" id="end_date" name="end_date" required>
                                        <div class="invalid-feedback">Please select end date</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="is_recurring" name="is_recurring">
                                        <label class="form-check-label" for="is_recurring">
                                            Recurring Deadline
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group" id="recurrenceField" style="display: none;">
                                        <label for="recurrence_pattern" class="form-label">Recurrence Pattern</label>
                                        <select class="form-select" id="recurrence_pattern" name="recurrence_pattern">
                                            <option value="">Select Pattern</option>
                                            <option value="daily">Daily</option>
                                            <option value="weekly">Weekly</option>
                                            <option value="monthly">Monthly</option>
                                            <option value="quarterly">Quarterly</option>
                                            <option value="yearly">Yearly</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-12">
                                    <div class="form-group">
                                        <label for="notes" class="form-label">Notes</label>
                                        <textarea class="form-control" id="notes" name="notes" rows="2"></textarea>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mb-3" id="statusField" style="display: none;">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="status_select" class="form-label">Status*</label>
                                        <select class="form-select" id="status_select" name="status_select" required>
                                            <option value="Pending">Pending</option>
                                            <option value="In Progress">In Progress</option>
                                            <option value="Completed">Completed</option>
                                            <option value="Overdue">Overdue</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary" id="saveBtn">Create Deadline</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
$(document).ready(function() {
    // Initialize DataTable
    var deadlinesTable = $('#deadlinesTable').DataTable({
    paging: true,
    searching: true,
    ordering: true,
    info: true,
    responsive: true,
    autoWidth: false,
    processing: true,
    serverSide: false,
    lengthMenu: [10, 25, 50, 100],
    pageLength: 10,
    ajax: {
        url: "{% url 'get_deadlines_data' %}",
        type: "GET",
        dataSrc: function(json) {
            if (json.success) {
                return json.data;
            } else {
                console.error('Error loading deadlines:', json.message);
                return [];
            }
        },
        error: function(xhr, error, thrown) {
            console.error('AJAX error:', error, thrown);
        }
    },
    columns: [
        { data: 'id' },
        { 
            data: 'title',
          
        },
        { 
            data: 'assigned_to',
            
        },
        { 
            data: 'deadline_type',
            
        },
        { 
            data: 'priority_level',
            render: function(data, type, row) {
                var color = row.priority_color || '#6c757d'; // Default color if missing
                return `<span class="badge" style="background-color: ${color}">${data}</span>`;
            }
        },
        { 
            data: 'start_date',
           
        },
        { 
            data: 'end_date',
            
        },
        { 
            data: 'days_remaining',
            render: function(data, type, row) {
                if (data === null || data === undefined) {
                    return
                }
                var badgeClass = row.is_overdue ? 'bg-danger' : (data <= 3 ? 'bg-warning' : 'bg-success');
                var text = row.is_overdue ? `${Math.abs(data)} days overdue` : `${data} days left`;
                return `<span class="badge ${badgeClass}">${text}</span>`;
            }
        },
        { 
            data: 'status',
            render: function(data) {
                var badgeClass = {
                    'Pending': 'bg-secondary',
                    'In Progress': 'bg-primary',
                    'Completed': 'bg-success',
                    'Overdue': 'bg-danger'
                }[data] || 'bg-secondary';
                return `<span class="badge ${badgeClass}">${data }</span>`;
            }
        },
        { 
            data: 'assigned_by',
            render: function(data, type, row) {
                return data || 'System';
            }
        },
        {
            data: 'id',
            render: function(data, type, row) {
                return `
                    <div class="btn-group">
                        <button class="btn btn-primary btn-sm edit-btn" data-id="${data}">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn btn-danger btn-sm delete-btn" data-id="${data}">
                            <i class="fas fa-trash-alt"></i> Delete
                        </button>
                    </div>
                `;
            },
            orderable: false
        }
    ],
    dom: 'Bfrtip',
    buttons: [
        {
            extend: "copy",
            text: '<i class="fas fa-copy"></i> Copy',
            className: "btn btn-sm btn-outline-secondary",
        },
        {
            extend: "csv",
            text: '<i class="fas fa-file-csv"></i> CSV',
            className: "btn btn-sm btn-outline-success",
        },
        {
            extend: "excel",
            text: '<i class="fas fa-file-excel"></i> Excel',
            className: "btn btn-sm btn-outline-primary",
        },
        {
            extend: "pdf",
            text: '<i class="fas fa-file-pdf"></i> PDF',
            className: "btn btn-sm btn-outline-danger",
        },
    ],
    language: {
        emptyTable: "No deadlines found. Click 'New Deadline' to add one.",
        zeroRecords: "No matching deadlines found.",
        processing: '<i class="fa fa-spinner fa-spin"></i> Loading deadlines...'
    }
});

// Add error handling for the table
deadlinesTable.on('error.dt', function(e, settings, techNote, message) {
    console.error('DataTables error:', message);
    alert('Error loading deadlines data. Please check console for details.');
});

    // Filter functionality
    $('.filter-btn').click(function() {
        $('.filter-btn').removeClass('active');
        $(this).addClass('active');
        
        var filter = $(this).data('filter');
        if (filter === 'all') {
            deadlinesTable.search('').draw();
        } else {
            deadlinesTable.search(filter.replace('_', ' ')).draw();
        }
    });

    // Toggle recurrence field
    $('#is_recurring').change(function() {
        $('#recurrenceField').toggle(this.checked);
    });

    // Load options data
    function loadOptionsData() {
        $.ajax({
            url: "{% url 'get_deadline_options' %}",
            type: "GET",
            success: function(response) {
                if (response.success) {
                    // Load deadline types
                    $('#deadline_type_id').empty().append('<option value="" selected disabled>Select Type</option>');
                    $.each(response.types, function(index, item) {
                        $('#deadline_type_id').append($('<option>', {
                            value: item.id,
                            text: item.name
                        }));
                    });
                    
                    // Load priority levels
                    $('#priority_level_id').empty().append('<option value="" selected disabled>Select Priority</option>');
                    $.each(response.priorities, function(index, item) {
                        $('#priority_level_id').append($('<option>', {
                            value: item.id,
                            text: item.name
                        }));
                    });
                    
                    // Load staff options
                    $('#assigned_to_id').empty().append('<option value="" selected disabled>Select Staff</option>');
                    $.each(response.staff, function(index, item) {
                        $('#assigned_to_id').append($('<option>', {
                            value: item.id,
                            text: item.name
                        }));
                    });
                    
                    // Initialize select2
                    $('.select2-single').select2({
                        theme: 'bootstrap-5',
                        width: '100%',
                        dropdownParent: $('#deadlineModal')
                    });
                } else {
                    showErrorAlert(response.message || 'Failed to load options');
                }
            },
            error: function() {
                showErrorAlert('Failed to load options data');
            }
        });
    }

    // ----- CREATE -----
    $('#addDeadlineBtn').click(function() {
        $('#deadlineForm')[0].reset();
        $('#modalTitle').text('New Deadline');
        $('#deadlineId').val('');
        $('#statusField').hide();
        $('#recurrenceField').hide();
        loadOptionsData();
        $('#deadlineModal').modal('show');
    });

    $('#deadlineForm').submit(function(e) {
        e.preventDefault();
        
        // Validate form
        if (!this.checkValidity()) {
            e.stopPropagation();
            this.classList.add('was-validated');
            return;
        }
        
        var formData = {
            'title': $('#title').val(),
            'description': $('#description').val(),
            'deadline_type_id': $('#deadline_type_id').val(),
            'priority_level_id': $('#priority_level_id').val(),
            'assigned_to_id': $('#assigned_to_id').val(),
            'staff_type': $('#staff_type').val(),
            'start_date': $('#start_date').val(),
            'end_date': $('#end_date').val(),
            'notes': $('#notes').val(),
            'is_recurring': $('#is_recurring').is(':checked'),
            'recurrence_pattern': $('#recurrence_pattern').val()
        };
        
        if ($('#deadlineId').val()) {
            // Update existing deadline
            var deadlineId = $('#deadlineId').val();
            formData.status = $('#status_select').val();
            updateDeadline(deadlineId, formData);
        } else {
            // Create new deadline
            createDeadline(formData);
        }
    });

    function createDeadline(formData) {
        $.ajax({
            url: "/portal/priorities-deadlines-create/",
            type: "POST",
            data: JSON.stringify(formData),
            contentType: "application/json",
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            beforeSend: function() {
                $('#saveBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Saving...');
            },
            success: function(response) {
                if (response.success) {
                    showSuccessAlert('Deadline created successfully');
                    $('#deadlineModal').modal('hide');
                    $('#deadlineForm').removeClass('was-validated');
                    deadlinesTable.ajax.reload(null, false);
                } else {
                    showErrorAlert(response.message || 'Failed to create deadline');
                }
            },
            error: function(xhr) {
                handleAjaxError(xhr, 'create deadline');
            },
            complete: function() {
                $('#saveBtn').prop('disabled', false).html('Create Deadline');
            }
        });
    }

    // ----- UPDATE -----
    $(document).on('click', '.edit-btn', function() {
        var deadlineId = $(this).data('id');
        getDeadlineDetails(deadlineId);
    });

    function getDeadlineDetails(deadlineId) {
        $.ajax({
            url: "{% url 'get_deadline_details' %}",
            type: "GET",
            data: { deadline_id: deadlineId },
            beforeSend: function() {
                showLoadingAlert('Loading deadline details...');
            },
            success: function(response) {
                Swal.close();
                if (response.success) {
                    var deadline = response.data;
                    $('#deadlineForm')[0].reset();
                    $('#modalTitle').text('Edit Deadline');
                    $('#deadlineId').val(deadlineId);
                    $('#statusField').show();
                    
                    // Set form values
                    $('#title').val(deadline.title);
                    $('#description').val(deadline.description);
                    $('#staff_type').val(deadline.staff_type);
                    $('#start_date').val(deadline.start_date);
                    $('#end_date').val(deadline.end_date);
                    $('#notes').val(deadline.notes);
                    $('#is_recurring').prop('checked', deadline.is_recurring);
                    $('#recurrence_pattern').val(deadline.recurrence_pattern);
                    $('#status_select').val(deadline.status);
                    
                    if (deadline.is_recurring) {
                        $('#recurrenceField').show();
                    }
                    
                    loadOptionsData();
                    
                    // Set values after select2 is initialized
                    setTimeout(function() {
                        $('#deadline_type_id').val(deadline.deadline_type_id).trigger('change');
                        $('#priority_level_id').val(deadline.priority_level_id).trigger('change');
                        $('#assigned_to_id').val(deadline.assigned_to_id).trigger('change');
                        $('#deadlineModal').modal('show');
                    }, 500);
                } else {
                    showErrorAlert(response.message || 'Failed to load deadline details');
                }
            },
            error: function(xhr) {
                handleAjaxError(xhr, 'load deadline details');
            }
        });
    }

    function updateDeadline(deadlineId, formData) {
        formData.status = $('#status_select').val();
        console.log(formData);
        $.ajax({
            url: "/portal/priorities-deadlines-update/" + deadlineId + "/",
            type: "POST",
            data: JSON.stringify(formData),
            contentType: "application/json",
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            beforeSend: function() {
                $('#saveBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Updating...');
            },
            success: function(response) {
                if (response.success) {
                    showSuccessAlert('Deadline updated successfully');
                    $('#deadlineModal').modal('hide');
                    $('#deadlineForm').removeClass('was-validated');
                    deadlinesTable.ajax.reload(null, false);
                } else {
                    showErrorAlert(response.message || 'Failed to update deadline');
                }
            },
            error: function(xhr) {
                handleAjaxError(xhr, 'update deadline');
            },
            complete: function() {
                $('#saveBtn').prop('disabled', false).html('Update Deadline');
            }
        });
    }

    // ----- DELETE -----
    $(document).on('click', '.delete-btn', function() {
        var deadlineId = $(this).data('id');
        
        Swal.fire({
            title: 'Are you sure?',
            text: "This deadline will be deleted. This action cannot be undone.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Yes, delete it!',
            cancelButtonText: 'Cancel'
        }).then((result) => {
            if (result.isConfirmed) {
                deleteDeadline(deadlineId);
            }
        });
    });

    function deleteDeadline(deadlineId) {
        $.ajax({
            url: "{% url 'delete_deadline' 0 %}".replace('0', deadlineId),
            type: "DELETE",
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            beforeSend: function() {
                showLoadingAlert('Deleting deadline...');
            },
            success: function(response) {
                Swal.close();
                if (response.success) {
                    showSuccessAlert('Deadline deleted successfully');
                    deadlinesTable.ajax.reload(null, false);
                } else {
                    showErrorAlert(response.message || 'Failed to delete deadline');
                }
            },
            error: function(xhr) {
                handleAjaxError(xhr, 'delete deadline');
            }
        });
    }

    // ==================== HELPER FUNCTIONS ====================
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function showSuccessAlert(message) {
        Swal.fire({
            icon: 'success',
            title: 'Success',
            text: message,
            timer: 1500,
            showConfirmButton: false
        });
    }

    function showErrorAlert(message) {
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: message
        });
    }

    function showLoadingAlert(message) {
        Swal.fire({
            title: 'Please wait...',
            text: message,
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });
    }

    function handleAjaxError(xhr, action) {
        let errorMsg = `An error occurred while trying to ${action}`;
        
        if (xhr.responseJSON) {
            if (xhr.responseJSON.message) {
                errorMsg = xhr.responseJSON.message;
            } else if (xhr.responseJSON.error) {
                errorMsg = xhr.responseJSON.error;
            } else if (xhr.responseJSON.detail) {
                errorMsg = xhr.responseJSON.detail;
            }
        } else if (xhr.status === 0) {
            errorMsg = 'Network error. Please check your connection.';
        } else if (xhr.statusText) {
            errorMsg = xhr.statusText;
        }
        
        showErrorAlert(errorMsg);
    }
});
</script>

<style>
.btn-gradient-primary {
    background: linear-gradient(45deg, #4e73df, #224abe);
    color: white;
    border: none;
    text-transform: uppercase;
    transition: background-color 0.3s ease-in-out, transform 0.3s ease-in-out;
}
.btn-gradient-primary:hover {
    background: linear-gradient(45deg, #2e59d9, #1e3a8a);
    transform: translateY(-1px);
}
.btn:focus {
    outline: none;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
}
.filter-btn.active {
    background-color: #4e73df;
    color: white;
    border-color: #4e73df;
}
</style>
{% endblock %}