<!-- quality_control/validate_data.html -->
{% extends 'base/web_base.html' %}
{% load static %}

{% block content %}
<div class="page-content">
    <div class="page-container">
        <br>
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div class="mb-3">
                            <div>
                                <h4 style="font-weight: bolder;">VALIDATE HOUSEHOLD SURVEYS</h4>
                                <p class="mb-0">Validate and approve household survey data for quality assurance</p>
                            </div>
                        </div>
                        <div>
                            <button class="btn btn-info btn-sm me-2" id="refreshBtn">
                                <i class="fas fa-sync-alt"></i> REFRESH
                            </button>
                            <button class="btn btn-primary btn-sm" id="viewRulesBtn">
                                <i class="fas fa-list-check"></i> VIEW VALIDATION RULES
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Filters -->
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <label class="form-label">Validation Status</label>
                                <select class="form-select" id="statusFilter">
                                    <option value="">All Statuses</option>
                                    <option value="pending_validation">Pending Validation</option>
                                    <option value="approved">Approved</option>
                                    <option value="rejected">Rejected</option>
                                    <option value="requires_correction">Requires Correction</option>
                                    <option value="not_validated">Not Validated</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Enumerator</label>
                                <select class="form-select" id="enumeratorFilter">
                                    <option value="">All Enumerators</option>
                                    <!-- Enumerators will be loaded via AJAX -->
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">District</label>
                                <select class="form-select" id="districtFilter">
                                    <option value="">All Districts</option>
                                    <!-- Districts will be loaded via AJAX -->
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Community</label>
                                <select class="form-select" id="communityFilter">
                                    <option value="">All Communities</option>
                                    <!-- Communities will be loaded via AJAX -->
                                </select>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label">Date From</label>
                                <input type="date" class="form-control" id="dateFromFilter">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Date To</label>
                                <input type="date" class="form-control" id="dateToFilter">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">&nbsp;</label>
                                <button class="btn btn-secondary w-100" id="clearFiltersBtn">
                                    <i class="fas fa-times"></i> CLEAR FILTERS
                                </button>
                            </div>
                        </div>

                        <!-- Statistics Cards -->
                        <div class="row mb-4">
                            <div class="col-md-2">
                                <div class="card bg-primary-subtle border-primary-subtle text-dark">
                                    <div class="card-body text-center">
                                        <h6 class="card-title text-muted small text-uppercase fw-bold">TOTAL SURVEYS</h6>
                                        <h3 class="fw-bold text-primary" id="totalSurveys">0</h3>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="card bg-warning-subtle border-warning-subtle text-dark">
                                    <div class="card-body text-center">
                                        <h6 class="card-title text-muted small text-uppercase fw-bold">PENDING</h6>
                                        <h3 class="fw-bold text-warning" id="pendingCount">0</h3>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="card bg-success-subtle border-success-subtle text-dark">
                                    <div class="card-body text-center">
                                        <h6 class="card-title text-muted small text-uppercase fw-bold">APPROVED</h6>
                                        <h3 class="fw-bold text-success" id="approvedCount">0</h3>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="card bg-danger-subtle border-danger-subtle text-dark">
                                    <div class="card-body text-center">
                                        <h6 class="card-title text-muted small text-uppercase fw-bold">REJECTED</h6>
                                        <h3 class="fw-bold text-danger" id="rejectedCount">0</h3>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="card bg-info-subtle border-info-subtle text-dark">
                                    <div class="card-body text-center">
                                        <h6 class="card-title text-muted small text-uppercase fw-bold">CORRECTION</h6>
                                        <h3 class="fw-bold text-info" id="correctionCount">0</h3>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="card bg-secondary-subtle border-secondary-subtle text-dark">
                                    <div class="card-body text-center">
                                        <h6 class="card-title text-muted small text-uppercase fw-bold">NOT VALIDATED</h6>
                                        <h3 class="fw-bold text-secondary" id="notValidatedCount">0</h3>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Surveys Table -->
                        <div class="table-responsive">
                            <table id="surveysTable" class="table table-striped table-bordered" style="width:100%">
                                <thead>
                                    <tr>
                                        <th>SURVEY ID</th>
                                        <th>FARMER</th>
                                        <th>COMMUNITY</th>
                                        <th>DISTRICT</th>
                                        <th>ENUMERATOR</th>
                                        <th>INTERVIEW DATE</th>
                                        <th>VALIDATION STATUS</th>
                                        <th>APPROVAL STATUS</th>
                                        <th>CREATED</th>
                                        <th>ACTIONS</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Data will be loaded via AJAX -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Survey Details Modal -->
        <div class="modal fade" id="surveyDetailModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header text-white bg-primary">
                        <h5 class="modal-title">Household Survey Details</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div id="surveyDetails">
                            <!-- Survey details will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Validation Modal -->
        <div class="modal fade" id="validationModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header text-white bg-primary">
                        <h5 class="modal-title">Validate Survey</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <form id="validationForm">
                        {% csrf_token %}
                        <input type="hidden" id="surveyId" name="surveyId">
                        <div class="modal-body">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i> This will run all validation rules against the survey data.
                            </div>
                            <div class="form-group">
                                <label class="form-label">Comments</label>
                                <textarea class="form-control" id="validationComments" name="comments" rows="3" placeholder="Add any comments about this validation"></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-danger" id="rejectSurveyBtn">Reject Survey</button>
                            <button type="submit" class="btn btn-primary">Run Validation</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Rejection Modal -->
        <div class="modal fade" id="rejectionModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header text-white bg-danger">
                        <h5 class="modal-title">Reject Survey</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <form id="rejectionForm">
                        {% csrf_token %}
                        <input type="hidden" id="rejectSurveyId" name="surveyId">
                        <div class="modal-body">
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle"></i> Please provide a reason for rejecting this survey.
                            </div>
                            <div class="form-group">
                                <label class="form-label">Reason for Rejection*</label>
                                <textarea class="form-control" id="rejectionReason" name="rejection_reason" rows="3" required placeholder="Explain why this survey is being rejected"></textarea>
                                <div class="invalid-feedback">Please provide a rejection reason</div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Additional Comments</label>
                                <textarea class="form-control" id="rejectionComments" name="comments" rows="2" placeholder="Any additional comments"></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-danger">Confirm Rejection</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Validation Rules Modal -->
        <div class="modal fade" id="rulesModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header text-white bg-info">
                        <h5 class="modal-title">Validation Rules</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Rule Name</th>
                                        <th>Type</th>
                                        <th>Severity</th>
                                        <th>Field</th>
                                        <th>Description</th>
                                        <th>Error Message</th>
                                    </tr>
                                </thead>
                                <tbody id="rulesTableBody">
                                    <!-- Rules will be loaded via AJAX -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript -->
 <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
$(document).ready(function() {
    // Initialize DataTable
    const surveysTable = $('#surveysTable').DataTable({
        paging: true,
        searching: true,
        ordering: true,
        info: true,
        responsive: true,
        autoWidth: false,
        processing: true,
        serverSide: false,
        lengthMenu: [10, 25, 50, 100],
        pageLength: 10,
        ajax: {
            url: "{% url 'household_surveys_list_api' %}",
            type: "GET",
            data: function(d) {
                return {
                    status: $('#statusFilter').val(),
                    enumerator: $('#enumeratorFilter').val(),
                    district: $('#districtFilter').val(),
                    community: $('#communityFilter').val(),
                    date_from: $('#dateFromFilter').val(),
                    date_to: $('#dateToFilter').val()
                };
            },
            dataSrc: function(json) {
                updateStatistics(json.statistics);
                return json.data;
            }
        },
        columns: [
            { data: 'survey_id' },
            { 
                data: 'farmer_name',
                render: function(data, type, row) {
                    return `${data} (${row.farmer_code})`;
                }
            },
            { data: 'community' },
            { data: 'district' },
            { data: 'enumerator' },
            { data: 'interview_date' },
            { 
                data: 'validation_status',
                render: function(data) {
                    return `
                        <div class="text-center">
                            <span class="badge bg-success">${data.passed}</span>
                            <span class="badge bg-danger">${data.failed}</span>
                            <span class="badge bg-warning">${data.pending}</span>
                            <small class="text-muted">/ ${data.total}</small>
                        </div>
                    `;
                }
            },
            { 
                data: 'approval_status',
                render: function(data, type, row) {
                    let badgeClass = 'bg-secondary';
                    if (data === 'approved') badgeClass = 'bg-success';
                    else if (data === 'rejected') badgeClass = 'bg-danger';
                    else if (data === 'requires_correction') badgeClass = 'bg-warning';
                    else if (data === 'pending') badgeClass = 'bg-info';
                    
                    return `<span class="badge ${badgeClass}">${data.replace(/_/g, ' ').toUpperCase()}</span>`;
                }
            },
            { data: 'created_at' },
            {
                data: 'id',
                render: function(data, type, row) {
                    return `
                        <div class="btn-group">
                            <button class="btn btn-primary btn-sm view-survey-btn" data-id="${data}" title="View Details">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-info btn-sm validate-survey-btn" data-id="${data}" title="Validate Survey">
                                <i class="fas fa-check-circle"></i>
                            </button>
                            ${row.requires_correction ? `
                            <button class="btn btn-warning btn-sm correction-btn" data-id="${data}" title="Requires Correction">
                                <i class="fas fa-exclamation-triangle"></i>
                            </button>
                            ` : ''}
                        </div>
                    `;
                },
                orderable: false
            }
        ],
        dom: 'Bfrtip',
        buttons: [
            {
                extend: "copy",
                text: '<i class="fas fa-copy"></i> Copy',
                className: "btn btn-sm btn-outline-secondary",
            },
            {
                extend: "csv",
                text: '<i class="fas fa-file-csv"></i> CSV',
                className: "btn btn-sm btn-outline-success",
            },
            {
                extend: "excel",
                text: '<i class="fas fa-file-excel"></i> Excel',
                className: "btn btn-sm btn-outline-primary",
            },
            {
                extend: "pdf",
                text: '<i class="fas fa-file-pdf"></i> PDF',
                className: "btn btn-sm btn-outline-danger",
            }
        ],
        language: {
            emptyTable: "No household surveys found.",
            zeroRecords: "No matching surveys found."
        }
    });

    // Load filter options
    function loadFilterOptions() {
        // Load enumerators
        $.ajax({
            url: "{% url 'get_enumerators_api' %}",
            type: "GET",
            success: function(data) {
                $('#enumeratorFilter').empty().append('<option value="" selected>All Enumerators</option>');
                $.each(data, function(index, item) {
                    $('#enumeratorFilter').append($('<option>', {
                        value: item.id,
                        text: `${item.first_name} ${item.last_name} (${item.staffid})`
                    }));
                });
            }
        });

        // Load communities
        $.ajax({
            url: "{% url 'get_communities_api' %}",
            type: "GET",
            success: function(data) {
                $('#communityFilter').empty().append('<option value="" selected>All Communities</option>');
                $.each(data, function(index, item) {
                    $('#communityFilter').append($('<option>', {
                        value: item.id,
                        text: item.society
                    }));
                });
            }
        });

        // Load districts would be similar...
    }

    // Update statistics
    function updateStatistics(stats) {
        $('#totalSurveys').text(stats.total_surveys);
        $('#pendingCount').text(stats.pending_validation);
        $('#approvedCount').text(stats.approved);
        $('#rejectedCount').text(stats.rejected);
        $('#correctionCount').text(stats.requires_correction);
        $('#notValidatedCount').text(stats.not_validated);
    }

    // Filter change events
    $('#statusFilter, #enumeratorFilter, #districtFilter, #communityFilter, #dateFromFilter, #dateToFilter').change(function() {
        surveysTable.ajax.reload();
    });

    // Clear filters
    $('#clearFiltersBtn').click(function() {
        $('#statusFilter, #enumeratorFilter, #districtFilter, #communityFilter').val('');
        $('#dateFromFilter, #dateToFilter').val('');
        surveysTable.ajax.reload();
    });

    // Refresh data
    $('#refreshBtn').click(function() {
        surveysTable.ajax.reload();
        showSuccessAlert('Data refreshed successfully');
    });

    // ----- VIEW SURVEY DETAILS -----
    $(document).on('click', '.view-survey-btn', function() {
        const surveyId = $(this).data('id');
        viewSurveyDetails(surveyId);
    });

    function viewSurveyDetails(surveyId) {
        $.ajax({
            url: "{% url 'household_survey_detail_api' 0 %}".replace('0', surveyId),
            type: "GET",
            beforeSend: function() {
                showLoadingAlert('Loading survey details...');
            },
            success: function(response) {
                Swal.close();
                if (response.success) {
                    displaySurveyDetails(response.data);
                    $('#surveyDetailModal').modal('show');
                } else {
                    showErrorAlert(response.message || 'Failed to load survey details');
                }
            },
            error: function(xhr) {
                handleAjaxError(xhr, 'load survey details');
            }
        });
    }

    function displaySurveyDetails(data) {
        const detailsHtml = `
            <div class="row mb-4">
                <div class="col-md-8">
                    <h4>Survey ${data.survey_id}</h4>
                    <p class="text-muted">Conducted on ${data.interview_info.start_time}</p>
                </div>
                <div class="col-md-4 text-end">
                    <span class="badge ${getApprovalBadgeClass(data.approval_info.status)} fs-6">
                        ${data.approval_info.status}
                    </span>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <div class="card mb-4">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">Farmer Information</h6>
                        </div>
                        <div class="card-body">
                            <div class="row mb-2">
                                <div class="col-6"><strong>Name:</strong></div>
                                <div class="col-6">${data.farmer.name}</div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-6"><strong>Farmer Code:</strong></div>
                                <div class="col-6">${data.farmer.code}</div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-6"><strong>Contact:</strong></div>
                                <div class="col-6">${data.farmer.contact}</div>
                            </div>
                        </div>
                    </div>

                    <div class="card mb-4">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">Location Information</h6>
                        </div>
                        <div class="card-body">
                            <div class="row mb-2">
                                <div class="col-6"><strong>Community:</strong></div>
                                <div class="col-6">${data.location.community}</div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-6"><strong>District:</strong></div>
                                <div class="col-6">${data.location.district}</div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-6"><strong>Community Type:</strong></div>
                                <div class="col-6">${data.location.community_type}</div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-6"><strong>GPS Point:</strong></div>
                                <div class="col-6">${data.location.gps_point}</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="card mb-4">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">Interview Information</h6>
                        </div>
                        <div class="card-body">
                            <div class="row mb-2">
                                <div class="col-6"><strong>Enumerator:</strong></div>
                                <div class="col-6">${data.enumerator.name}</div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-6"><strong>Staff ID:</strong></div>
                                <div class="col-6">${data.enumerator.staff_id}</div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-6"><strong>Start Time:</strong></div>
                                <div class="col-6">${data.interview_info.start_time}</div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-6"><strong>End Time:</strong></div>
                                <div class="col-6">${data.interview_info.end_time}</div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-6"><strong>Farmer Available:</strong></div>
                                <div class="col-6">${data.interview_info.farmer_available}</div>
                            </div>
                            ${data.interview_info.reason_unavailable ? `
                            <div class="row mb-2">
                                <div class="col-6"><strong>Reason Unavailable:</strong></div>
                                <div class="col-6">${data.interview_info.reason_unavailable}</div>
                            </div>
                            ` : ''}
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">Household Composition</h6>
                        </div>
                        <div class="card-body">
                            <div class="row mb-2">
                                <div class="col-6"><strong>Total Adults:</strong></div>
                                <div class="col-6">${data.household_composition.total_adults}</div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-6"><strong>Number of Children (5-17):</strong></div>
                                <div class="col-6">${data.household_composition.num_children}</div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-6"><strong>Children Present:</strong></div>
                                <div class="col-6">${data.household_composition.children_present}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            ${data.validation_results.length > 0 ? `
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">Validation Results</h6>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Rule Name</th>
                                            <th>Type</th>
                                            <th>Severity</th>
                                            <th>Status</th>
                                            <th>Error Details</th>
                                            <th>Validated By</th>
                                            <th>Validated At</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${data.validation_results.map(result => `
                                            <tr>
                                                <td>${result.rule_name}</td>
                                                <td>${result.rule_type}</td>
                                                <td><span class="badge ${getSeverityBadgeClass(result.severity)}">${result.severity}</span></td>
                                                <td><span class="badge ${getStatusBadgeClass(result.status)}">${result.status}</span></td>
                                                <td>${result.error_details || '-'}</td>
                                                <td>${result.validated_by}</td>
                                                <td>${result.validated_at}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            ` : ''}

            ${data.approval_info.status !== 'Not Validated' ? `
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">Approval Information</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <strong>Status:</strong> ${data.approval_info.status}
                                </div>
                                ${data.approval_info.approved_by ? `
                                <div class="col-md-6">
                                    <strong>Approved By:</strong> ${data.approval_info.approved_by} at ${data.approval_info.approved_at}
                                </div>
                                ` : ''}
                                ${data.approval_info.rejected_by ? `
                                <div class="col-md-6">
                                    <strong>Rejected By:</strong> ${data.approval_info.rejected_by} at ${data.approval_info.rejected_at}
                                </div>
                                ` : ''}
                            </div>
                            ${data.approval_info.rejection_reason ? `
                            <div class="row mt-2">
                                <div class="col-12">
                                    <strong>Rejection Reason:</strong> ${data.approval_info.rejection_reason}
                                </div>
                            </div>
                            ` : ''}
                            ${data.approval_info.comments ? `
                            <div class="row mt-2">
                                <div class="col-12">
                                    <strong>Comments:</strong> ${data.approval_info.comments}
                                </div>
                            </div>
                            ` : ''}
                            ${data.approval_info.correction_required ? `
                            <div class="row mt-2">
                                <div class="col-12">
                                    <div class="alert alert-warning">
                                        <strong>Correction Required:</strong> ${data.approval_info.correction_details}
                                        ${data.approval_info.correction_deadline ? `<br><strong>Deadline:</strong> ${data.approval_info.correction_deadline}` : ''}
                                    </div>
                                </div>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            </div>
            ` : ''}
        `;
        
        $('#surveyDetails').html(detailsHtml);
    }

    function getApprovalBadgeClass(status) {
        status = status.toLowerCase();
        if (status.includes('approved')) return 'bg-success';
        if (status.includes('rejected')) return 'bg-danger';
        if (status.includes('pending')) return 'bg-warning';
        if (status.includes('correction')) return 'bg-info';
        return 'bg-secondary';
    }

    function getSeverityBadgeClass(severity) {
        severity = severity.toLowerCase();
        if (severity === 'critical') return 'bg-danger';
        if (severity === 'high') return 'bg-warning';
        if (severity === 'medium') return 'bg-info';
        return 'bg-secondary';
    }

    function getStatusBadgeClass(status) {
        status = status.toLowerCase();
        if (status === 'passed') return 'bg-success';
        if (status === 'failed') return 'bg-danger';
        if (status === 'pending') return 'bg-warning';
        return 'bg-secondary';
    }

    // ----- VALIDATE SURVEY -----
    $(document).on('click', '.validate-survey-btn', function() {
        const surveyId = $(this).data('id');
        $('#surveyId').val(surveyId);
        $('#validationComments').val('');
        $('#validationModal').modal('show');
    });

    $('#validationForm').submit(function(e) {
        e.preventDefault();
        const surveyId = $('#surveyId').val();
        validateSurvey(surveyId);
    });

    function validateSurvey(surveyId) {
        const formData = {
            comments: $('#validationComments').val()
        };
        
        $.ajax({
            url: "{% url 'validate_household_survey_api' 0 %}".replace('0', surveyId),
            type: "POST",
            data: JSON.stringify(formData),
            contentType: "application/json",
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            beforeSend: function() {
                $('#validationModal').modal('hide');
                showLoadingAlert('Validating survey...');
            },
            success: function(response) {
                Swal.close();
                if (response.success) {
                    if (response.data.all_passed) {
                        showSuccessAlert('Survey validation completed successfully! All checks passed.');
                    } else {
                        showWarningAlert('Survey validation completed. Some checks failed. Review required.');
                    }
                    surveysTable.ajax.reload();
                } else {
                    showErrorAlert(response.message || 'Failed to validate survey');
                }
            },
            error: function(xhr) {
                handleAjaxError(xhr, 'validate survey');
            }
        });
    }
 // ----- REJECT SURVEY -----
    $('#rejectSurveyBtn').click(function() {
        const surveyId = $('#surveyId').val();
        $('#rejectSurveyId').val(surveyId);
        $('#rejectionReason').val('');
        $('#rejectionComments').val('');
        $('#validationModal').modal('hide');
        $('#rejectionModal').modal('show');
    });

    $('#rejectionForm').submit(function(e) {
        e.preventDefault();
        if (!this.checkValidity()) {
            e.stopPropagation();
            this.classList.add('was-validated');
            return;
        }
        
        const surveyId = $('#rejectSurveyId').val();
        rejectSurvey(surveyId);
    });

    function rejectSurvey(surveyId) {
        const formData = {
            rejection_reason: $('#rejectionReason').val(),
            comments: $('#rejectionComments').val()
        };
        
        $.ajax({
            url: "{% url 'reject_household_survey_api' 0 %}".replace('0', surveyId),
            type: "POST",
            data: JSON.stringify(formData),
            contentType: "application/json",
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            beforeSend: function() {
                $('#rejectionModal').modal('hide');
                showLoadingAlert('Rejecting survey...');
            },
            success: function(response) {
                Swal.close();
                if (response.success) {
                    showSuccessAlert('Survey rejected successfully');
                    surveysTable.ajax.reload();
                } else {
                    showErrorAlert(response.message || 'Failed to reject survey');
                }
            },
            error: function(xhr) {
                handleAjaxError(xhr, 'reject survey');
            }
        });
    }

    // ----- VIEW VALIDATION RULES -----
    $('#viewRulesBtn').click(function() {
        loadValidationRules();
        $('#rulesModal').modal('show');
    });

    function loadValidationRules() {
        $.ajax({
            url: "{% url 'get_validation_rules_api' %}",
            type: "GET",
            beforeSend: function() {
                $('#rulesTableBody').html('<tr><td colspan="6" class="text-center">Loading rules...</td></tr>');
            },
            success: function(data) {
                if (data.length > 0) {
                    const rulesHtml = data.map(rule => `
                        <tr>
                            <td>${rule.name}</td>
                            <td><span class="badge bg-info">${rule.rule_type}</span></td>
                            <td><span class="badge ${getSeverityBadgeClass(rule.severity)}">${rule.severity}</span></td>
                            <td>${rule.field_name || 'N/A'}</td>
                            <td>${rule.description}</td>
                            <td>${rule.error_message}</td>
                        </tr>
                    `).join('');
                    $('#rulesTableBody').html(rulesHtml);
                } else {
                    $('#rulesTableBody').html('<tr><td colspan="6" class="text-center">No validation rules found</td></tr>');
                }
            },
            error: function(xhr) {
                $('#rulesTableBody').html('<tr><td colspan="6" class="text-center text-danger">Error loading rules</td></tr>');
                handleAjaxError(xhr, 'load validation rules');
            }
        });
    }

    // ----- HELPER FUNCTIONS -----
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function showSuccessAlert(message) {
        Swal.fire({
            icon: 'success',
            title: 'Success',
            text: message,
            timer: 1500,
            showConfirmButton: false
        });
    }

    function showWarningAlert(message) {
        Swal.fire({
            icon: 'warning',
            title: 'Warning',
            text: message,
            timer: 2000,
            showConfirmButton: false
        });
    }

    function showErrorAlert(message) {
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: message
        });
    }

    function showLoadingAlert(message) {
        Swal.fire({
            title: 'Please wait...',
            text: message,
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });
    }

    function handleAjaxError(xhr, action) {
        let errorMsg = `An error occurred while trying to ${action}`;
        
        try {
            const response = JSON.parse(xhr.responseText);
            if (response.message) {
                errorMsg = response.message;
            } else if (response.error) {
                errorMsg = response.error;
            }
        } catch (e) {
            if (xhr.status === 0) {
                errorMsg = 'Network error. Please check your connection.';
            } else if (xhr.statusText) {
                errorMsg = xhr.statusText;
            }
        }
        
        showErrorAlert(errorMsg);
    }

    function getSeverityBadgeClass(severity) {
        severity = severity.toLowerCase();
        if (severity === 'critical') return 'bg-danger';
        if (severity === 'high') return 'bg-warning';
        if (severity === 'medium') return 'bg-info';
        return 'bg-secondary';
    }

    // ----- INITIALIZATION -----
    $(document).ready(function() {
        // Initialize the page
        loadFilterOptions();
        surveysTable.ajax.reload();
        
        // Set default date range to last 30 days
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
        $('#dateFromFilter').val(thirtyDaysAgo.toISOString().split('T')[0]);
        $('#dateToFilter').val(new Date().toISOString().split('T')[0]);
    });

});
</script>


<style>
.badge {
    font-size: 0.85em;
    padding: 0.5em 0.75em;
}
.card {
    margin-bottom: 1rem;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}
/* .card-header {
    background-color: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
} */
/* .table th {
    background-color: #f8f9fa;
    font-weight: 600;
} */
.btn-group .btn {
    margin-right: 0.25rem;
}
.bg-primary-subtle {
    background-color: #cfe2ff !important;
    border-color: #b6d4fe !important;
}
.bg-success-subtle {
    background-color: #d1e7dd !important;
    border-color: #badbcc !important;
}
.bg-warning-subtle {
    background-color: #fff3cd !important;
    border-color: #ffecb5 !important;
}
.bg-danger-subtle {
    background-color: #f8d7da !important;
    border-color: #f1aeb5 !important;
}
.bg-info-subtle {
    background-color: #cff4fc !important;
    border-color: #9eeaf9 !important;
}
.bg-secondary-subtle {
    background-color: #e2e3e5 !important;
    border-color: #c4c8cb !important;
}
.text-primary { color: #0d6efd !important; }
.text-success { color: #198754 !important; }
.text-warning { color: #ffc107 !important; }
.text-danger { color: #dc3545 !important; }
.text-info { color: #0dcaf0 !important; }
.text-secondary { color: #6c757d !important; }

/* Custom badge colors for approval status */
.badge.bg-approved { background-color: #198754; }
.badge.bg-rejected { background-color: #dc3545; }
.badge.bg-pending { background-color: #ffc107; color: #000; }
.badge.bg-requires_correction { background-color: #0dcaf0; }
.badge.bg-not_validated { background-color: #6c757d; }

/* Hover effects */
.btn:hover {
    transform: translateY(-1px);
    transition: all 0.2s ease-in-out;
}
.card:hover {
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    transition: all 0.2s ease-in-out;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .card-body {
        padding: 1rem;
    }
    .btn-group .btn {
        margin-bottom: 0.25rem;
    }
    .table-responsive {
        font-size: 0.875rem;
    }
}

/* Loading animation */
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
.spinner-border {
    animation: spin 0.75s linear infinite;
}

/* Custom scrollbar for modals */
.modal-body {
    max-height: 70vh;
    overflow-y: auto;
}
.modal-body::-webkit-scrollbar {
    width: 8px;
}
.modal-body::-webkit-scrollbar-track {
    background: #f1f1f1;
}
.modal-body::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 4px;
}
.modal-body::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

/* Enhanced table styling */
.table-hover tbody tr:hover {
    background-color: rgba(0, 123, 255, 0.075);
}
.table-sm th, .table-sm td {
    padding: 0.5rem;
}

/* Filter section styling */
/* .form-label {
    font-weight: 500;
    margin-bottom: 0.5rem;
}
.form-select, .form-control {
    border-radius: 0.375rem;
    border: 1px solid #ced4da;
    transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
}
.form-select:focus, .form-control:focus {
    border-color: #86b7fe;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
} */

/* Button enhancements */
.btn {
    border-radius: 0.375rem;
    font-weight: 500;
    transition: all 0.15s ease-in-out;
}
.btn-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
}

/* Alert styling */
.alert {
    border-radius: 0.375rem;
    border: 1px solid transparent;
}
.alert-info {
    background-color: #cff4fc;
    border-color: #b6effb;
    color: #055160;
}
.alert-warning {
    background-color: #fff3cd;
    border-color: #ffecb5;
    color: #664d03;
}

/* Modal enhancements */
.modal-header {
    border-bottom: 1px solid #dee2e6;
    padding: 1rem 1.5rem;
}
.modal-footer {
    border-top: 1px solid #dee2e6;
    padding: 1rem 1.5rem;
}

/* Statistics cards hover effect */
.card.bg-primary-subtle:hover,
.card.bg-success-subtle:hover,
.card.bg-warning-subtle:hover,
.card.bg-danger-subtle:hover,
.card.bg-info-subtle:hover,
.card.bg-secondary-subtle:hover {
    transform: translateY(-2px);
    transition: all 0.2s ease-in-out;
}

/* Badge enhancements */
.badge {
    font-weight: 600;
    letter-spacing: 0.5px;
}

/* Form validation styling */
.was-validated .form-control:invalid,
.form-control.is-invalid {
    border-color: #dc3545;
    padding-right: calc(1.5em + 0.75rem);
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath d='m5.8 3.6.4.4.4-.4'/%3e%3cpath d='M6 7v2'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right calc(0.375em + 0.1875rem) center;
    background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
}
.invalid-feedback {
    display: none;
    width: 100%;
    margin-top: 0.25rem;
    font-size: 0.875em;
    color: #dc3545;
}
.was-validated .form-control:invalid ~ .invalid-feedback,
.form-control.is-invalid ~ .invalid-feedback {
    display: block;
}

/* DataTable customizations */
.dataTables_wrapper .dataTables_length,
.dataTables_wrapper .dataTables_filter,
.dataTables_wrapper .dataTables_info,
.dataTables_wrapper .dataTables_paginate {
    margin: 1rem 0;
}
.dataTables_wrapper .dataTables_paginate .paginate_button {
    border-radius: 0.375rem;
    margin: 0 0.25rem;
}
.dataTables_wrapper .dataTables_paginate .paginate_button.current {
    background: #0d6efd;
    color: white !important;
    border: 1px solid #0d6efd;
}

/* Custom button styles for export buttons */
.dt-buttons .btn {
    margin-right: 0.5rem;
    margin-bottom: 0.5rem;
}

/* Responsive table adjustments */
@media (max-width: 991.98px) {
    .table-responsive {
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
    }
}

/* Animation for modal transitions */
.modal.fade .modal-dialog {
    transition: transform 0.3s ease-out;
    transform: translate(0, -50px);
}
.modal.show .modal-dialog {
    transform: none;
}

/* Custom focus styles for accessibility */
.btn:focus,
.form-control:focus,
.form-select:focus {
    outline: 0;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

/* Loading state for buttons */
.btn-loading {
    position: relative;
    color: transparent !important;
    pointer-events: none;
}
.btn-loading::after {
    content: '';
    position: absolute;
    left: 50%;
    top: 50%;
    width: 1rem;
    height: 1rem;
    margin-left: -0.5rem;
    margin-top: -0.5rem;
    border: 2px solid #fff;
    border-radius: 50%;
    border-right-color: transparent;
    animation: spin 0.75s linear infinite;
}

/* Enhanced hover effects for action buttons */
.btn-group .btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.1);
}

/* Custom transitions for smooth interactions */
.card,
.btn,
.badge,
.table-responsive {
    transition: all 0.2s ease-in-out;
}

/* Improved text readability */
body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    line-height: 1.6;
    color: #212529;
}

/* Enhanced modal backdrop */
.modal-backdrop {
    background-color: rgba(0, 0, 0, 0.5);
}

/* Custom scrollbar for webkit browsers */
::-webkit-scrollbar {
    width: 12px;
}
::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 6px;
}
::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 6px;
    border: 2px solid #f1f1f1;
}
::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

/* Print styles */
@media print {
    .btn,
    .dataTables_length,
    .dataTables_filter,
    .dataTables_paginate,
    .modal,
    .modal-backdrop {
        display: none !important;
    }
    .card {
        border: 1px solid #000 !important;
        box-shadow: none !important;
    }
    .table {
        font-size: 12px;
    }
}
</style>
{% endblock %}