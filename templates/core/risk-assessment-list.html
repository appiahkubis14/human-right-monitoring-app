{% extends 'base/web_base.html' %}
{% load static %}

{% block content %}

<div class="page-content">
    <div class="page-container">

    <div class="content container-fluid">
        <!-- Page Header -->
         <br>
        <div class="page-header" style="display: flex;justify-content: space-between;">
            <div class="col">
                <h3 class="page-title">Child Labour Risk Classification</h3>
                <ul class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/">Dashboard</a></li>
                    <li class="breadcrumb-item active">Risk Management</li>
                    <li class="breadcrumb-item active">Risk Classification</li>
                </ul>
            </div>
            <div class="col-auto">
                <button class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#addAssessmentModal">
                    <i class="ti ti-plus me-1"></i> New Assessment
                </button>
                <button class="btn btn-outline-secondary" id="exportBtn">
                    <i class="ti ti-download me-1"></i> Export
                </button>
            </div>
        </div>
        <!-- /Page Header -->

        <!-- Risk Stats Cards -->
        <div class="row">
            <div class="col-xl-3 col-sm-6 col-12">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-muted">Total Assessments</h6>
                                <h4 class="mb-0">127</h4>
                            </div>
                            <div class="avatar bg-light-primary">
                                <i class="ti ti-clipboard-list fs-4"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-sm-6 col-12">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-muted">High Risk</h6>
                                <h4 class="mb-0">23</h4>
                            </div>
                            <div class="avatar bg-light-danger">
                                <i class="ti ti-alert-triangle fs-4"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-sm-6 col-12">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-muted">Medium Risk</h6>
                                <h4 class="mb-0">45</h4>
                            </div>
                            <div class="avatar bg-light-warning">
                                <i class="ti ti-alert-circle fs-4"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-sm-6 col-12">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-muted">Low Risk</h6>
                                <h4 class="mb-0">59</h4>
                            </div>
                            <div class="avatar bg-light-success">
                                <i class="ti ti-circle-check fs-4"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- /Risk Stats Cards -->

        <!-- Risk Classification Table -->
        <div class="row">
            <div class="col-sm-12">
                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table id="riskTable" class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Ref ID</th>
                                        <th>Child Name</th>
                                        <th>Age</th>
                                        <th>Parent/Farmer</th>
                                        <th>Community</th>
                                        <th>Risk Score</th>
                                        <th>Risk Level</th>
                                        <th>Assessment Date</th>
                                        <th>Last Follow-up</th>
                                        <th>Status</th>
                                        <th class="text-end">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>RA-2023-001</td>
                                        <td>Kwame Mensah</td>
                                        <td>14</td>
                                        <td>Kofi Mensah</td>
                                        <td>North Community</td>
                                        <td>82</td>
                                        <td><span class="badge bg-danger">High Risk</span></td>
                                        <td>15 Oct 2023</td>
                                        <td>20 Nov 2023</td>
                                        <td><span class="badge bg-warning">Needs Intervention</span></td>
                                        <td class="text-end">
                                            <div class="dropdown dropdown-action">
                                                <a href="#" class="action-icon dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false"><i class="ti ti-dots-vertical"></i></a>
                                                <div class="dropdown-menu dropdown-menu-right">
                                                    <a class="dropdown-item" href="#"><i class="ti ti-eye me-2"></i>View Details</a>
                                                    <a class="dropdown-item" href="#"><i class="ti ti-edit me-2"></i>Update Assessment</a>
                                                    <a class="dropdown-item" href="#"><i class="ti ti-calendar me-2"></i>Schedule Follow-up</a>
                                                    <a class="dropdown-item" href="#"><i class="ti ti-report me-2"></i>Generate Report</a>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>RA-2023-002</td>
                                        <td>Ama Owusu</td>
                                        <td>12</td>
                                        <td>Yaw Owusu</td>
                                        <td>South Community</td>
                                        <td>65</td>
                                        <td><span class="badge bg-warning">Medium Risk</span></td>
                                        <td>18 Oct 2023</td>
                                        <td>25 Nov 2023</td>
                                        <td><span class="badge bg-info">Monitoring</span></td>
                                        <td class="text-end">
                                            <div class="dropdown dropdown-action">
                                                <a href="#" class="action-icon dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false"><i class="ti ti-dots-vertical"></i></a>
                                                <div class="dropdown-menu dropdown-menu-right">
                                                    <a class="dropdown-item" href="#"><i class="ti ti-eye me-2"></i>View Details</a>
                                                    <a class="dropdown-item" href="#"><i class="ti ti-edit me-2"></i>Update Assessment</a>
                                                    <a class="dropdown-item" href="#"><i class="ti ti-calendar me-2"></i>Schedule Follow-up</a>
                                                    <a class="dropdown-item" href="#"><i class="ti ti-report me-2"></i>Generate Report</a>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>RA-2023-003</td>
                                        <td>Yaw Boateng</td>
                                        <td>15</td>
                                        <td>Kwasi Boateng</td>
                                        <td>East Community</td>
                                        <td>45</td>
                                        <td><span class="badge bg-success">Low Risk</span></td>
                                        <td>22 Oct 2023</td>
                                        <td>30 Nov 2023</td>
                                        <td><span class="badge bg-success">Stable</span></td>
                                        <td class="text-end">
                                            <div class="dropdown dropdown-action">
                                                <a href="#" class="action-icon dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false"><i class="ti ti-dots-vertical"></i></a>
                                                <div class="dropdown-menu dropdown-menu-right">
                                                    <a class="dropdown-item" href="#"><i class="ti ti-eye me-2"></i>View Details</a>
                                                    <a class="dropdown-item" href="#"><i class="ti ti-edit me-2"></i>Update Assessment</a>
                                                    <a class="dropdown-item" href="#"><i class="ti ti-calendar me-2"></i>Schedule Follow-up</a>
                                                    <a class="dropdown-item" href="#"><i class="ti ti-report me-2"></i>Generate Report</a>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>RA-2023-004</td>
                                        <td>Akua Manu</td>
                                        <td>13</td>
                                        <td>Kwame Manu</td>
                                        <td>West Community</td>
                                        <td>78</td>
                                        <td><span class="badge bg-danger">High Risk</span></td>
                                        <td>25 Oct 2023</td>
                                        <td>02 Dec 2023</td>
                                        <td><span class="badge bg-danger">Urgent Action</span></td>
                                        <td class="text-end">
                                            <div class="dropdown dropdown-action">
                                                <a href="#" class="action-icon dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false"><i class="ti ti-dots-vertical"></i></a>
                                                <div class="dropdown-menu dropdown-menu-right">
                                                    <a class="dropdown-item" href="#"><i class="ti ti-eye me-2"></i>View Details</a>
                                                    <a class="dropdown-item" href="#"><i class="ti ti-edit me-2"></i>Update Assessment</a>
                                                    <a class="dropdown-item" href="#"><i class="ti ti-calendar me-2"></i>Schedule Follow-up</a>
                                                    <a class="dropdown-item" href="#"><i class="ti ti-report me-2"></i>Generate Report</a>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>RA-2023-005</td>
                                        <td>Kofi Ansah</td>
                                        <td>11</td>
                                        <td>Nana Ansah</td>
                                        <td>Central Community</td>
                                        <td>58</td>
                                        <td><span class="badge bg-warning">Medium Risk</span></td>
                                        <td>28 Oct 2023</td>
                                        <td>05 Dec 2023</td>
                                        <td><span class="badge bg-info">Monitoring</span></td>
                                        <td class="text-end">
                                            <div class="dropdown dropdown-action">
                                                <a href="#" class="action-icon dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false"><i class="ti ti-dots-vertical"></i></a>
                                                <div class="dropdown-menu dropdown-menu-right">
                                                    <a class="dropdown-item" href="#"><i class="ti ti-eye me-2"></i>View Details</a>
                                                    <a class="dropdown-item" href="#"><i class="ti ti-edit me-2"></i>Update Assessment</a>
                                                    <a class="dropdown-item" href="#"><i class="ti ti-calendar me-2"></i>Schedule Follow-up</a>
                                                    <a class="dropdown-item" href="#"><i class="ti ti-report me-2"></i>Generate Report</a>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>RA-2023-006</td>
                                        <td>Abena Sarpong</td>
                                        <td>16</td>
                                        <td>Kwaku Sarpong</td>
                                        <td>North Community</td>
                                        <td>35</td>
                                        <td><span class="badge bg-success">Low Risk</span></td>
                                        <td>02 Nov 2023</td>
                                        <td>10 Dec 2023</td>
                                        <td><span class="badge bg-success">Stable</span></td>
                                        <td class="text-end">
                                            <div class="dropdown dropdown-action">
                                                <a href="#" class="action-icon dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false"><i class="ti ti-dots-vertical"></i></a>
                                                <div class="dropdown-menu dropdown-menu-right">
                                                    <a class="dropdown-item" href="#"><i class="ti ti-eye me-2"></i>View Details</a>
                                                    <a class="dropdown-item" href="#"><i class="ti ti-edit me-2"></i>Update Assessment</a>
                                                    <a class="dropdown-item" href="#"><i class="ti ti-calendar me-2"></i>Schedule Follow-up</a>
                                                    <a class="dropdown-item" href="#"><i class="ti ti-report me-2"></i>Generate Report</a>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>RA-2023-007</td>
                                        <td>Yaa Twum</td>
                                        <td>14</td>
                                        <td>Kwabena Twum</td>
                                        <td>South Community</td>
                                        <td>85</td>
                                        <td><span class="badge bg-danger">High Risk</span></td>
                                        <td>05 Nov 2023</td>
                                        <td>12 Dec 2023</td>
                                        <td><span class="badge bg-danger">Urgent Action</span></td>
                                        <td class="text-end">
                                            <div class="dropdown dropdown-action">
                                                <a href="#" class="action-icon dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false"><i class="ti ti-dots-vertical"></i></a>
                                                <div class="dropdown-menu dropdown-menu-right">
                                                    <a class="dropdown-item" href="#"><i class="ti ti-eye me-2"></i>View Details</a>
                                                    <a class="dropdown-item" href="#"><i class="ti ti-edit me-2"></i>Update Assessment</a>
                                                    <a class="dropdown-item" href="#"><i class="ti ti-calendar me-2"></i>Schedule Follow-up</a>
                                                    <a class="dropdown-item" href="#"><i class="ti ti-report me-2"></i>Generate Report</a>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>RA-2023-008</td>
                                        <td>Nana Kwaku</td>
                                        <td>12</td>
                                        <td>Osei Kwaku</td>
                                        <td>East Community</td>
                                        <td>62</td>
                                        <td><span class="badge bg-warning">Medium Risk</span></td>
                                        <td>08 Nov 2023</td>
                                        <td>15 Dec 2023</td>
                                        <td><span class="badge bg-warning">Needs Intervention</span></td>
                                        <td class="text-end">
                                            <div class="dropdown dropdown-action">
                                                <a href="#" class="action-icon dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false"><i class="ti ti-dots-vertical"></i></a>
                                                <div class="dropdown-menu dropdown-menu-right">
                                                    <a class="dropdown-item" href="#"><i class="ti ti-eye me-2"></i>View Details</a>
                                                    <a class="dropdown-item" href="#"><i class="ti ti-edit me-2"></i>Update Assessment</a>
                                                    <a class="dropdown-item" href="#"><i class="ti ti-calendar me-2"></i>Schedule Follow-up</a>
                                                    <a class="dropdown-item" href="#"><i class="ti ti-report me-2"></i>Generate Report</a>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- /Risk Classification Table -->
    </div>

    <!-- Add Assessment Modal -->
    <div class="modal fade" id="addAssessmentModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">New Risk Assessment</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Select Child</label>
                                    <select class="form-select">
                                        <option value="">Select Child</option>
                                        <option value="C001">Kwame Mensah (14 years)</option>
                                        <option value="C002">Ama Owusu (12 years)</option>
                                        <option value="C003">Yaw Boateng (15 years)</option>
                                        <option value="C004">Akua Manu (13 years)</option>
                                        <option value="C005">Kofi Ansah (11 years)</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Assessment Date</label>
                                    <input type="date" class="form-control">
                                </div>
                            </div>
                        </div>
                        
                        <h6 class="mt-4 mb-3">Risk Factors</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Hours of Work per Week</label>
                                    <input type="number" class="form-control" placeholder="Enter hours">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>School Attendance</label>
                                    <select class="form-select">
                                        <option value="">Select attendance</option>
                                        <option value="regular">Regular (90-100%)</option>
                                        <option value="irregular">Irregular (70-89%)</option>
                                        <option value="poor">Poor (Below 70%)</option>
                                        <option value="none">Not Attending</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Type of Work</label>
                                    <select class="form-select">
                                        <option value="">Select work type</option>
                                        <option value="hazardous">Hazardous Activities</option>
                                        <option value="heavy">Heavy Lifting</option>
                                        <option value="chemical">Chemical Exposure</option>
                                        <option value="light">Light Duties</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Family Economic Status</label>
                                    <select class="form-select">
                                        <option value="">Select status</option>
                                        <option value="critical">Critical (No stable income)</option>
                                        <option value="poor">Poor (Irregular income)</option>
                                        <option value="moderate">Moderate (Basic needs met)</option>
                                        <option value="stable">Stable (Secure income)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <h6 class="mt-4 mb-3">Assessment Notes</h6>
                        <div class="form-group">
                            <textarea class="form-control" rows="3" placeholder="Enter assessment observations and notes"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary">Save Assessment</button>
                </div>
            </div>
        </div>
    </div>
    <!-- /Add Assessment Modal -->
    </div>
</div>


<!-- DataTables CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css">
<style>
    /* Custom styling for DataTables */
    .dataTables_wrapper .dataTables_filter {
        float: right;
        text-align: right;
    }
    
    .dataTables_wrapper .dataTables_length {
        float: left;
    }
    
    .dataTables_wrapper .dataTables_info {
        float: left;
    }
    
    .dataTables_wrapper .dataTables_paginate {
        float: right;
    }
    
    .table-responsive {
        overflow-x: auto;
    }
    
    #riskTable tr.selected {
        background-color: rgba(13, 110, 253, 0.1) !important;
    }
    
    .dt-button-collection {
        display: none;
        position: absolute;
        background: white;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 5px;
        z-index: 1000;
    }
    
    .filter-container {
        margin-bottom: 15px;
        padding: 15px;
        background-color: #f8f9fa;
        border-radius: 5px;
    }
    
    /* Risk level badges */
    .badge.bg-danger { background-color: #dc3545 !important; }
    .badge.bg-warning { background-color: #ffc107 !important; color: #000; }
    .badge.bg-success { background-color: #198754 !important; }
    .badge.bg-info { background-color: #0dcaf0 !important; color: #000; }
</style>

<!-- First load jQuery, then DataTables and its extensions -->
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.bootstrap5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.colVis.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap5.min.js"></script>

<script>
$(document).ready(function() {
    // Initialize DataTable with comprehensive features
    var table = $('#riskTable').DataTable({
        processing: true,
        dom: '<"row"<"col-md-3"l><"col-md-5"B><"col-md-4"f>>' +
             '<"row"<"col-md-12"tr>>' +
             '<"row"<"col-md-6"i><"col-md-6"p>>',
        buttons: [
            {
                extend: 'collection',
                text: '<i class="ti ti-settings me-1"></i> Settings',
                className: 'btn btn-sm btn-outline-secondary dropdown-toggle',
                buttons: [
                    {
                        extend: 'colvis',
                        text: 'Column Visibility',
                        className: 'dropdown-item'
                    },
                    {
                        extend: 'pageLength',
                        text: 'Page Length',
                        className: 'dropdown-item'
                    }
                ]
            },
            {
                extend: 'collection',
                text: '<i class="ti ti-download me-1"></i> Export',
                className: 'btn btn-sm btn-outline-secondary dropdown-toggle',
                buttons: [
                    {
                        extend: 'copy',
                        text: 'Copy to clipboard',
                        className: 'dropdown-item',
                        exportOptions: {
                            columns: ':visible'
                        }
                    },
                    {
                        extend: 'csv',
                        text: 'Export as CSV',
                        className: 'dropdown-item',
                        exportOptions: {
                            columns: ':visible'
                        }
                    },
                    {
                        extend: 'excel',
                        text: 'Export as Excel',
                        className: 'dropdown-item',
                        exportOptions: {
                            columns: ':visible'
                        }
                    },
                    {
                        extend: 'pdf',
                        text: 'Export as PDF',
                        className: 'dropdown-item',
                        exportOptions: {
                            columns: ':visible'
                        }
                    },
                    {
                        extend: 'print',
                        text: 'Print',
                        className: 'dropdown-item',
                        exportOptions: {
                            columns: ':visible'
                        },
                        customize: function (win) {
                            $(win.document.body).find('h1').text('Child Labour Risk Assessment Report');
                        }
                    }
                ]
            },
            {
                text: '<i class="ti ti-refresh me-1"></i> Refresh',
                className: 'btn btn-sm btn-outline-secondary',
                action: function (e, dt, node, config) {
                    dt.ajax.reload();
                }
            }
        ],
        language: {
            search: "_INPUT_",
            searchPlaceholder: "Search assessments...",
            lengthMenu: "Show _MENU_ entries",
            paginate: {
                previous: "<i class='ti ti-chevron-left'>",
                next: "<i class='ti ti-chevron-right'>"
            },
            info: "Showing _START_ to _END_ of _TOTAL_ assessments",
            infoEmpty: "Showing 0 to 0 of 0 assessments",
            infoFiltered: "(filtered from _MAX_ total assessments)"
        },
        pageLength: 10,
        lengthMenu: [[5, 10, 25, 50, -1], [5, 10, 25, 50, "All"]],
        responsive: true,
        ordering: true,
        order: [[5, 'desc']], // Default sort by Risk Score descending
        columnDefs: [
            { 
                orderable: false, 
                targets: -1, // Actions column
                searchable: false
            },
            {
                targets: [5], // Risk Score column
                type: 'num'
            },
            {
                targets: [2], // Age column
                type: 'num'
            }
        ]
    });

    // Style DataTable buttons
    $('.dt-buttons .btn').removeClass('btn-secondary');
    
    // Export button click handler
    $('#exportBtn').on('click', function() {
        $('.dt-button-collection').show();
    });
    
    // Add filter container above the table
    $('<div class="filter-container"><h6>Filter Risk Assessments</h6><div class="row"></div></div>').insertBefore('#riskTable_wrapper');
    
    // Risk Level filter
    $('<div class="col-md-3 mb-2"><label>Risk Level: </label>' +
      '<select id="riskLevelFilter" class="form-select form-select-sm">' +
      '<option value="">All Levels</option>' +
      '<option value="high">High Risk</option>' +
      '<option value="medium">Medium Risk</option>' +
      '<option value="low">Low Risk</option>' +
      '</select></div>').appendTo('.filter-container .row');
    
    $.fn.dataTable.ext.search.push(
        function(settings, data, dataIndex) {
            var riskLevel = $('#riskLevelFilter').val();
            if (!riskLevel) {
                return true;
            }
            
            var rowRisk = data[6].toLowerCase(); // Risk level is in column index 6
            return rowRisk.indexOf(riskLevel.toLowerCase()) !== -1;
        }
    );
    
    $('#riskLevelFilter').on('change', function() {
        table.draw();
    });
    
    // Status filter
    $('<div class="col-md-3 mb-2"><label>Status: </label>' +
      '<select id="statusFilter" class="form-select form-select-sm">' +
      '<option value="">All Status</option>' +
      '<option value="urgent">Urgent Action</option>' +
      '<option value="intervention">Needs Intervention</option>' +
      '<option value="monitoring">Monitoring</option>' +
      '<option value="stable">Stable</option>' +
      '</select></div>').appendTo('.filter-container .row');
    
    $.fn.dataTable.ext.search.push(
        function(settings, data, dataIndex) {
            var status = $('#statusFilter').val();
            if (!status) {
                return true;
            }
            
            var rowStatus = data[9].toLowerCase(); // Status is in column index 9
            return rowStatus.indexOf(status.toLowerCase()) !== -1;
        }
    );
    
    $('#statusFilter').on('change', function() {
        table.draw();
    });
    
    // Community filter
    $('<div class="col-md-3 mb-2"><label>Community: </label>' +
      '<select id="communityFilter" class="form-select form-select-sm">' +
      '<option value="">All Communities</option>' +
      '<option value="north">North Community</option>' +
      '<option value="south">South Community</option>' +
      '<option value="east">East Community</option>' +
      '<option value="west">West Community</option>' +
      '<option value="central">Central Community</option>' +
      '</select></div>').appendTo('.filter-container .row');
    
    $.fn.dataTable.ext.search.push(
        function(settings, data, dataIndex) {
            var community = $('#communityFilter').val();
            if (!community) {
                return true;
            }
            
            var rowCommunity = data[4].toLowerCase(); // Community is in column index 4
            return rowCommunity.indexOf(community.toLowerCase()) !== -1;
        }
    );
    
    $('#communityFilter').on('change', function() {
        table.draw();
    });
    
    // Add clear filters button
    $('<div class="col-md-3 mb-2"><label>&nbsp;</label><br>' +
      '<button class="btn btn-sm btn-outline-secondary w-100" id="clearFilters">Clear Filters</button></div>')
      .appendTo('.filter-container .row')
      .on('click', function() {
          $('#riskLevelFilter, #statusFilter, #communityFilter').val('');
          table.search('').columns().search('').draw();
      });
    
    // Row selection highlighting
    $('#riskTable tbody').on('click', 'tr', function() {
        $(this).toggleClass('selected');
    });
    
    // // Add a custom button to get selected rows
    // $('<button class="btn btn-sm btn-primary ms-2" id="getSelected">Get Selected Assessments</button>')
    //     .insertAfter('#clearFilters')
    //     .on('click', function() {
    //         var selectedRows = table.rows('.selected').data();
    //         var selectedCount = selectedRows.length;
            
    //         if (selectedCount > 0) {
    //             var assessmentRefs = [];
    //             for (var i = 0; i < selectedCount; i++) {
    //                 assessmentRefs.push(selectedRows[i][0]); // Ref ID is in column index 0
    //             }
    //             alert('Selected assessments: ' + assessmentRefs.join(', '));
    //         } else {
    //             alert('No assessments selected.');
    //         }
    //     });
    
    // Risk score color coding
    $('#riskTable tbody tr').each(function() {
        var riskScore = parseInt($(this).find('td:eq(5)').text());
        if (riskScore >= 70) {
            $(this).find('td:eq(5)').css('color', '#dc3545').css('font-weight', 'bold');
        } else if (riskScore >= 50) {
            $(this).find('td:eq(5)').css('color', '#ffc107').css('font-weight', 'bold');
        } else {
            $(this).find('td:eq(5)').css('color', '#198754').css('font-weight', 'bold');
        }
    });
});
</script>
{% endblock %}