<!-- pci/community_pci.html -->
{% extends 'base/web_base.html' %}
{% load static %}

{% block content %}
<div class="page-content">
    <div class="page-container">
        <br>
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div class="mb-3">
                            <div>
                                <h4 style="font-weight: bolder;">COMMUNITY PROTECTIVE INDEX (PCI)</h4>
                                <p class="mb-0">Manage and monitor community protective index assessments</p>
                            </div>
                        </div>
                        <button class="btn btn-gradient-primary btn-sm" id="newPciBtn">
                            <i class="fas fa-plus"></i> NEW PCI ASSESSMENT
                        </button>
                    </div>
                    <div class="card-body">
                        <!-- Filters -->
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <label class="form-label">Risk Status</label>
                                <select class="form-select" id="statusFilter">
                                    <option value="">All Statuses</option>
                                    <option value="low_risk">Low Risk</option>
                                    <option value="medium_risk">Medium Risk</option>
                                    <option value="high_risk">High Risk</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">District</label>
                                <select class="form-select" id="districtFilter">
                                    <option value="">All Districts</option>
                                    <!-- Districts will be loaded via AJAX -->
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Community</label>
                                <select class="form-select" id="communityFilter">
                                    <option value="">All Communities</option>
                                    <!-- Communities will be loaded via AJAX -->
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Enumerator</label>
                                <select class="form-select" id="enumeratorFilter">
                                    <option value="">All Enumerators</option>
                                    <!-- Enumerators will be loaded via AJAX -->
                                </select>
                            </div>
                        </div>

                        <!-- Statistics Cards -->
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <div class="card bg-success text-white">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between">
                                            <div>
                                                <h6 class="card-title">LOW RISK</h6>
                                                <h3 id="lowRiskCount">0</h3>
                                            </div>
                                            <div class="align-self-center">
                                                <i class="fas fa-shield-alt fa-2x"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-warning text-white">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between">
                                            <div>
                                                <h6 class="card-title">MEDIUM RISK</h6>
                                                <h3 id="mediumRiskCount">0</h3>
                                            </div>
                                            <div class="align-self-center">
                                                <i class="fas fa-exclamation-triangle fa-2x"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-danger text-white">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between">
                                            <div>
                                                <h6 class="card-title">HIGH RISK</h6>
                                                <h3 id="highRiskCount">0</h3>
                                            </div>
                                            <div class="align-self-center">
                                                <i class="fas fa-radiation fa-2x"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-info text-white">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between">
                                            <div>
                                                <h6 class="card-title">TOTAL ASSESSMENTS</h6>
                                                <h3 id="totalAssessments">0</h3>
                                            </div>
                                            <div class="align-self-center">
                                                <i class="fas fa-chart-line fa-2x"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- PCI Table -->
                        <div class="table-responsive">
                            <table id="pciTable" class="table table-striped table-bordered" style="width:100%">
                                <thead>
                                    <tr>
                                        <th>ASSESSMENT ID</th>
                                        <th>COMMUNITY</th>
                                        <th>DISTRICT</th>
                                        <th>ENUMERATOR</th>
                                        <th>PCI SCORE</th>
                                        <th>RISK STATUS</th>
                                        <th>ASSESSMENT DATE</th>
                                        <th>WATER ACCESS</th>
                                        <th>ADULT LABOR</th>
                                        <th>AWARENESS</th>
                                        <th>WOMEN LEADERS</th>
                                        <th>ACTIONS</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Data will be loaded via AJAX -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- PCI Assessment Modal -->
        <div class="modal fade" id="pciModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header text-white bg-primary">
                        <h5 class="modal-title" id="modalTitle">New PCI Assessment</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <form id="pciForm" class="needs-validation" novalidate>
                        {% csrf_token %}
                        <input type="hidden" id="pciId" name="pciId">
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header bg-light">
                                            <h6 class="mb-0">Community Information</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <div class="form-group">
                                                        <label for="district" class="form-label">District*</label>
                                                        <select class="form-select" id="district" name="district" required>
                                                            <option value="" selected disabled>Select District</option>
                                                            <!-- Districts will be loaded via AJAX -->
                                                        </select>
                                                        <div class="invalid-feedback">Please select district</div>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="form-group">
                                                        <label for="community" class="form-label">Community*</label>
                                                        <select class="form-select" id="community" name="community" required>
                                                            <option value="" selected disabled>Select Community</option>
                                                            <!-- Communities will be loaded via AJAX -->
                                                        </select>
                                                        <div class="invalid-feedback">Please select community</div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <div class="form-group">
                                                        <label for="enumerator" class="form-label">Enumerator*</label>
                                                        <select class="form-select" id="enumerator" name="enumerator" required>
                                                            <option value="" selected disabled>Select Enumerator</option>
                                                            <!-- Enumerators will be loaded via AJAX -->
                                                        </select>
                                                        <div class="invalid-feedback">Please select enumerator</div>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="form-group">
                                                        <label for="assessment_date" class="form-label">Assessment Date*</label>
                                                        <input type="date" class="form-control" id="assessment_date" name="assessment_date" required>
                                                        <div class="invalid-feedback">Please select assessment date</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header bg-light">
                                            <h6 class="mb-0">Assessment Results</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="text-center p-3 border rounded mb-3">
                                                        <h4 id="pciScore">0.00</h4>
                                                        <small class="text-muted">PCI Score</small>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="text-center p-3 border rounded mb-3">
                                                        <h4 id="riskStatus">-</h4>
                                                        <small class="text-muted">Risk Status</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- PCI Indicators -->
                            <div class="row mt-4">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-header bg-light">
                                            <h6 class="mb-0">Protective Indicators (Score 0-1 for each)</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-6 mb-3">
                                                    <label class="form-label">Access to Protected Water Source*</label>
                                                    <p class="text-muted small">Do most households have access to protected water?</p>
                                                    <select class="form-select pci-indicator" id="water_access" name="water_access" required>
                                                        <option value="" selected disabled>Select score</option>
                                                        <option value="0">0 - No</option>
                                                        <option value="1">1 - Yes</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-6 mb-3">
                                                    <label class="form-label">Adult Labor Hiring*</label>
                                                    <p class="text-muted small">Do households hire adult laborers?</p>
                                                    <select class="form-select pci-indicator" id="adult_labor" name="adult_labor" required>
                                                        <option value="" selected disabled>Select score</option>
                                                        <option value="0">0 - No</option>
                                                        <option value="1">1 - Yes</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-6 mb-3">
                                                    <label class="form-label">Awareness Raising Sessions*</label>
                                                    <p class="text-muted small">Child labor awareness sessions in past year?</p>
                                                    <select class="form-select pci-indicator" id="awareness" name="awareness" required>
                                                        <option value="" selected disabled>Select score</option>
                                                        <option value="0">0 - No</option>
                                                        <option value="1">1 - Yes</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-6 mb-3">
                                                    <label class="form-label">Women in Leadership*</label>
                                                    <p class="text-muted small">Are there women among community leaders?</p>
                                                    <select class="form-select pci-indicator" id="women_leaders" name="women_leaders" required>
                                                        <option value="" selected disabled>Select score</option>
                                                        <option value="0">0 - No</option>
                                                        <option value="1">1 - Yes</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-6 mb-3">
                                                    <label class="form-label">Pre-school Availability*</label>
                                                    <p class="text-muted small">Is there at least one pre-school?</p>
                                                    <select class="form-select pci-indicator" id="pre_school" name="pre_school" required>
                                                        <option value="" selected disabled>Select score</option>
                                                        <option value="0">0 - No</option>
                                                        <option value="1">1 - Yes</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-6 mb-3">
                                                    <label class="form-label">Primary School Availability*</label>
                                                    <p class="text-muted small">Is there at least one primary school?</p>
                                                    <select class="form-select pci-indicator" id="primary_school" name="primary_school" required>
                                                        <option value="" selected disabled>Select score</option>
                                                        <option value="0">0 - No</option>
                                                        <option value="1">1 - Yes</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-6 mb-3">
                                                    <label class="form-label">Separate Toilets in Schools*</label>
                                                    <p class="text-muted small">Separate toilets for boys and girls?</p>
                                                    <select class="form-select pci-indicator" id="separate_toilets" name="separate_toilets" required>
                                                        <option value="" selected disabled>Select score</option>
                                                        <option value="0">0 - No</option>
                                                        <option value="1">1 - Yes</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-6 mb-3">
                                                    <label class="form-label">School Food Provision*</label>
                                                    <p class="text-muted small">Do schools provide food?</p>
                                                    <select class="form-select pci-indicator" id="provide_food" name="provide_food" required>
                                                        <option value="" selected disabled>Select score</option>
                                                        <option value="0">0 - No</option>
                                                        <option value="1">1 - Yes</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-6 mb-3">
                                                    <label class="form-label">Scholarship Access*</label>
                                                    <p class="text-muted small">Children access scholarships for high school?</p>
                                                    <select class="form-select pci-indicator" id="scholarships" name="scholarships" required>
                                                        <option value="" selected disabled>Select score</option>
                                                        <option value="0">0 - No</option>
                                                        <option value="1">1 - Yes</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-6 mb-3">
                                                    <label class="form-label">No Corporal Punishment*</label>
                                                    <p class="text-muted small">Absence of corporal punishment in schools?</p>
                                                    <select class="form-select pci-indicator" id="corporal_punishment" name="corporal_punishment" required>
                                                        <option value="" selected disabled>Select score</option>
                                                        <option value="0">0 - No</option>
                                                        <option value="1">1 - Yes</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary" id="saveBtn">Save Assessment</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- View PCI Details Modal -->
        <div class="modal fade" id="viewPciModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header text-white bg-primary">
                        <h5 class="modal-title">PCI Assessment Details</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div id="pciDetails">
                            <!-- PCI details will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- 
 <button class="btn btn-info btn-sm edit-pci-btn" data-id="${data}" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button> -->

<!-- JavaScript -->
 <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
$(document).ready(function() {
    // Initialize DataTable
    const pciTable = $('#pciTable').DataTable({
        paging: true,
        searching: true,
        ordering: true,
        info: true,
        responsive: true,
        autoWidth: false,
        processing: true,
        serverSide: false,
        lengthMenu: [10, 25, 50, 100],
        pageLength: 10,
        ajax: {
            url: "{% url 'pci_list_api' %}",
            type: "GET",
            data: function(d) {
                return {
                    status: $('#statusFilter').val(),
                    district: $('#districtFilter').val(),
                    community: $('#communityFilter').val(),
                    enumerator: $('#enumeratorFilter').val()
                };
            },
            dataSrc: function(json) {
                updateStatistics(json.statistics);
                return json.data;
            }
        },
        columns: [
            { data: 'assessment_id' },
            { data: 'community' },
            { data: 'district' },
            { data: 'enumerator' },
            { 
                data: 'total_index',
                render: function(data) {
                    return `<span class="fw-bold">${data}</span>`;
                }
            },
            { 
                data: 'status',
                render: function(data, type, row) {
                    let badgeClass = 'bg-secondary';
                    if (data === 'low_risk') badgeClass = 'bg-success';
                    else if (data === 'medium_risk') badgeClass = 'bg-warning';
                    else if (data === 'high_risk') badgeClass = 'bg-danger';
                    
                    return `<span class="badge ${badgeClass}">${data.replace('_', ' ').toUpperCase()}</span>`;
                }
            },
            { data: 'assessment_date' },
            { 
                data: 'water_access',
                render: function(data) {
                    return data == 1 ? '<i class="fas fa-check text-success"></i>' : '<i class="fas fa-times text-danger"></i>';
                }
            },
            { 
                data: 'adult_labor',
                render: function(data) {
                    return data == 1 ? '<i class="fas fa-check text-success"></i>' : '<i class="fas fa-times text-danger"></i>';
                }
            },
            { 
                data: 'awareness',
                render: function(data) {
                    return data == 1 ? '<i class="fas fa-check text-success"></i>' : '<i class="fas fa-times text-danger"></i>';
                }
            },
            { 
                data: 'women_leaders',
                render: function(data) {
                    return data == 1 ? '<i class="fas fa-check text-success"></i>' : '<i class="fas fa-times text-danger"></i>';
                }
            },
            {
                data: 'id',
                render: function(data, type, row) {
                    return `
                        <div class="btn-group">
                            <button class="btn btn-primary btn-sm view-pci-btn" data-id="${data}" title="View Details">
                                <i class="fas fa-eye"></i>
                            </button>
                           
                            <button class="btn btn-danger btn-sm delete-pci-btn" data-id="${data}" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                },
                orderable: false
            }
        ],
        dom: 'Bfrtip',
        buttons: [
            {
                extend: "copy",
                text: '<i class="fas fa-copy"></i> Copy',
                className: "btn btn-sm btn-outline-secondary",
            },
            {
                extend: "csv",
                text: '<i class="fas fa-file-csv"></i> CSV',
                className: "btn btn-sm btn-outline-success",
            },
            {
                extend: "excel",
                text: '<i class="fas fa-file-excel"></i> Excel',
                className: "btn btn-sm btn-outline-primary",
            },
            {
                extend: "pdf",
                text: '<i class="fas fa-file-pdf"></i> PDF',
                className: "btn btn-sm btn-outline-danger",
            },
            {
                text: '<i class="fas fa-chart-bar"></i> Report',
                className: "btn btn-sm btn-outline-info",
                action: function() {
                    generatePciReport();
                }
            }
        ],
        language: {
            emptyTable: "No PCI assessments found. Click 'New PCI Assessment' to create one.",
            zeroRecords: "No matching assessments found."
        }
    });

    // Load filter options
    function loadFilterOptions() {
        // Load districts
        $.ajax({
            url: "{% url 'get_districts_api' %}",
            type: "GET",
            success: function(data) {
                $('#districtFilter, #district').empty().append('<option value="" selected disabled>Select District</option>');
                $.each(data, function(index, item) {
                    $('#districtFilter, #district').append($('<option>', {
                        value: item.id,
                        text: item.district
                    }));
                });
            }
        });

        // Load communities
        $.ajax({
            url: "{% url 'get_communities_api' %}",
            type: "GET",
            success: function(data) {
                $('#communityFilter, #community').empty().append('<option value="" selected disabled>Select Community</option>');
                $.each(data, function(index, item) {
                    $('#communityFilter, #community').append($('<option>', {
                        value: item.id,
                        text: item.society
                    }));
                });
            }
        });

        // Load enumerators
       $.ajax({
            url: "{% url 'get_enumerators_api' %}",
            type: "GET",
            success: function(data) {
                $('#enumeratorFilter, #enumerator').empty().append('<option value="" selected disabled>Select Enumerator</option>');
                $.each(data.data, function(index, item) {
                    // Access the flat structure from .values() query
                    $('#enumeratorFilter, #enumerator').append($('<option>', {
                        value: item.id,  // Make sure 'id' is included in values()
                        text: `${item.staffTbl_foreignkey__first_name} ${item.staffTbl_foreignkey__last_name} (${item.staffTbl_foreignkey__staffid})`
                    }));
                });
            }
        });
    }

    // Update statistics
    function updateStatistics(stats) {
        $('#totalAssessments').text(stats.total_assessments);
        $('#lowRiskCount').text(stats.low_risk_count);
        $('#mediumRiskCount').text(stats.medium_risk_count);
        $('#highRiskCount').text(stats.high_risk_count);
    }

    // Filter change events
    $('#statusFilter, #districtFilter, #communityFilter, #enumeratorFilter').change(function() {
        pciTable.ajax.reload();
    });

    // Calculate PCI score on indicator change
    $('.pci-indicator').change(function() {
        calculatePciScore();
    });

    function calculatePciScore() {
        let totalScore = 0;
        let answeredCount = 0;
        
        $('.pci-indicator').each(function() {
            const value = $(this).val();
            if (value !== '' && value !== null) {
                totalScore += parseFloat(value);
                answeredCount++;
            }
        });
        
        $('#pciScore').text(totalScore.toFixed(2));
        
        // Determine risk status
        let riskStatus = '-';
        let riskClass = 'text-muted';
        
        if (answeredCount === 10) { // All questions answered
            if (totalScore <= 4) {
                riskStatus = 'HIGH RISK';
                riskClass = 'text-danger';
            } else if (totalScore <= 6) {
                riskStatus = 'MEDIUM RISK';
                riskClass = 'text-warning';
            } else {
                riskStatus = 'LOW RISK';
                riskClass = 'text-success';
            }
        }
        
        $('#riskStatus').html(`<span class="${riskClass} fw-bold">${riskStatus}</span>`);
    }

    // ----- CREATE NEW PCI ASSESSMENT -----
    $('#newPciBtn').click(function() {
        $('#pciForm')[0].reset();
        $('#modalTitle').text('New PCI Assessment');
        $('#pciId').val('');
        $('#pciScore').text('0.00');
        $('#riskStatus').html('<span class="text-muted">-</span>');
        
        loadFilterOptions();
        $('#pciModal').modal('show');
    });

    $('#pciForm').submit(function(e) {
        e.preventDefault();
        
        // Validate form
        if (!this.checkValidity()) {
            e.stopPropagation();
            this.classList.add('was-validated');
            return;
        }
        
        const formData = {
            society_id: $('#community').val(),
            enumerator_id: $('#enumerator').val(),
            assessment_date: $('#assessment_date').val(),
            access_to_protected_water: $('#water_access').val(),
            hire_adult_labourers: $('#adult_labor').val(),
            awareness_raising_session: $('#awareness').val(),
            women_leaders: $('#women_leaders').val(),
            pre_school: $('#pre_school').val(),
            primary_school: $('#primary_school').val(),
            separate_toilets: $('#separate_toilets').val(),
            provide_food: $('#provide_food').val(),
            scholarships: $('#scholarships').val(),
            corporal_punishment: $('#corporal_punishment').val()
        };
        
        createPciAssessment(formData);
    });

    function createPciAssessment(formData) {
        $.ajax({
            url: "{% url 'create_pci_api' %}",
            type: "POST",
            data: JSON.stringify(formData),
            contentType: "application/json",
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            beforeSend: function() {
                $('#saveBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Saving...');
            },
            success: function(response) {
                if (response.success) {
                    showSuccessAlert('PCI assessment created successfully');
                    $('#pciModal').modal('hide');
                    $('#pciForm').removeClass('was-validated');
                    pciTable.ajax.reload();
                } else {
                    showErrorAlert(response.message || 'Failed to create PCI assessment');
                }
            },
            error: function(xhr) {
                handleAjaxError(xhr, 'create PCI assessment');
            },
            complete: function() {
                $('#saveBtn').prop('disabled', false).html('Save Assessment');
            }
        });
    }

    // ----- VIEW PCI DETAILS -----
    $(document).on('click', '.view-pci-btn', function() {
        const pciId = $(this).data('id');
        viewPciDetails(pciId);
    });

    function viewPciDetails(pciId) {
        $.ajax({
            url: "{% url 'pci_detail_api' 0 %}".replace('0', pciId),
            type: "GET",
            beforeSend: function() {
                showLoadingAlert('Loading PCI details...');
            },
            success: function(response) {
                Swal.close();
                if (response.success) {
                    displayPciDetails(response.data);
                    $('#viewPciModal').modal('show');
                } else {
                    showErrorAlert(response.message || 'Failed to load PCI details');
                }
            },
            error: function(xhr) {
                handleAjaxError(xhr, 'load PCI details');
            }
        });
    }

    function displayPciDetails(data) {
        const detailsHtml = `
            <div class="row mb-4">
                <div class="col-md-8">
                    <h5>${data.community}</h5>
                    <p class="text-muted">${data.district} â€¢ ${data.assessment_date}</p>
                </div>
                <div class="col-md-4 text-end">
                    <div class="d-flex justify-content-end align-items-center">
                        <div class="me-3">
                            <h4 class="mb-0">${data.total_index}</h4>
                            <small class="text-muted">PCI Score</small>
                        </div>
                        <span class="badge ${getRiskBadgeClass(data.status)} fs-6">
                            ${data.status.replace('_', ' ').toUpperCase()}
                        </span>
                    </div>
                </div>
            </div>
            
            <div class="row mb-4">
                <div class="col-md-6">
                    <strong>Enumerator:</strong> ${data.enumerator}
                </div>
                <div class="col-md-6">
                    <strong>Assessment Date:</strong> ${data.assessment_date}
                </div>
            </div>
            
            <h6 class="mb-3">Protective Indicators</h6>
            <div class="row">
                ${data.indicators.map(indicator => `
                    <div class="col-md-6 mb-3">
                        <div class="card">
                            <div class="card-body p-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1">${indicator.name}</h6>
                                        <p class="text-muted small mb-0">${indicator.description}</p>
                                    </div>
                                    <span class="badge ${indicator.score == 1 ? 'bg-success' : 'bg-danger'}">
                                        ${indicator.score == 1 ? 'Yes' : 'No'}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('')}
            </div>
            
            <div class="mt-4 p-3 bg-light rounded">
                <h6>Risk Assessment Summary</h6>
                <p class="mb-2"><strong>Total Score:</strong> ${data.total_index} out of 10</p>
                <p class="mb-2"><strong>Risk Level:</strong> ${data.status.replace('_', ' ').toUpperCase()}</p>
                <p class="mb-0"><strong>Recommendation:</strong> ${getRecommendation(data.status)}</p>
            </div>
        `;
        
        $('#pciDetails').html(detailsHtml);
    }

    function getRiskBadgeClass(status) {
        switch(status) {
            case 'low_risk': return 'bg-success';
            case 'medium_risk': return 'bg-warning';
            case 'high_risk': return 'bg-danger';
            default: return 'bg-secondary';
        }
    }

    function getRecommendation(status) {
        switch(status) {
            case 'low_risk':
                return 'Community shows strong protective factors. Continue monitoring and support existing programs.';
            case 'medium_risk':
                return 'Community has moderate protective factors. Implement targeted interventions and increase awareness campaigns.';
            case 'high_risk':
                return 'Community shows weak protective factors. Urgent interventions needed. Prioritize child protection programs and community support.';
            default:
                return 'No recommendation available.';
        }
    }

    // ----- EDIT PCI ASSESSMENT -----
    $(document).on('click', '.edit-pci-btn', function() {
        const pciId = $(this).data('id');
        // Implement edit functionality similar to view but with form
        showErrorAlert('Edit functionality will be implemented in the next phase');
    });

    // ----- DELETE PCI ASSESSMENT -----
    $(document).on('click', '.delete-pci-btn', function() {
        const pciId = $(this).data('id');
        
        Swal.fire({
            title: 'Delete Assessment?',
            text: "Are you sure you want to delete this PCI assessment? This action cannot be undone.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Yes, delete it!',
            cancelButtonText: 'Cancel'
        }).then((result) => {
            if (result.isConfirmed) {
                deletePciAssessment(pciId);
            }
        });
    });

    function deletePciAssessment(pciId) {
        $.ajax({
            url: "{% url 'delete_pci_api' 0 %}".replace('0', pciId),
            type: "DELETE",
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            beforeSend: function() {
                showLoadingAlert('Deleting assessment...');
            },
            success: function(response) {
                Swal.close();
                if (response.success) {
                    showSuccessAlert('PCI assessment deleted successfully');
                    pciTable.ajax.reload();
                } else {
                    showErrorAlert(response.message || 'Failed to delete assessment');
                }
            },
            error: function(xhr) {
                handleAjaxError(xhr, 'delete assessment');
            }
        });
    }

    // Generate PCI Report
    function generatePciReport() {
        // Implement report generation
        showSuccessAlert('Report generation will be implemented in the next phase');
    }

    // Initialize page
    loadFilterOptions();
    pciTable.ajax.reload();

    // Set default assessment date to today
    $('#assessment_date').val(new Date().toISOString().split('T')[0]);




    // Helper functions for AJAX requests
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function showSuccessAlert(message) {
    Swal.fire({
        icon: 'success',
        title: 'Success',
        text: message,
        timer: 3000,
        showConfirmButton: false
    });
}

function showErrorAlert(message) {
    Swal.fire({
        icon: 'error',
        title: 'Error',
        text: message,
        timer: 5000
    });
}

function showLoadingAlert(message) {
    Swal.fire({
        title: 'Please wait...',
        text: message,
        allowOutsideClick: false,
        didOpen: () => {
            Swal.showLoading();
        }
    });
}

function handleAjaxError(xhr, action) {
    let errorMessage = `Failed to ${action}. `;
    
    if (xhr.responseJSON && xhr.responseJSON.message) {
        errorMessage += xhr.responseJSON.message;
    } else if (xhr.status === 0) {
        errorMessage += 'Network error. Please check your connection.';
    } else if (xhr.status === 404) {
        errorMessage += 'Resource not found.';
    } else if (xhr.status === 500) {
        errorMessage += 'Server error. Please try again later.';
    } else {
        errorMessage += 'Unknown error occurred.';
    }
    
    showErrorAlert(errorMessage);
}


});

// ==================== HELPER FUNCTIONS ====================
// (Include all the helper functions from previous JavaScript code)
// getCookie, showSuccessAlert, showErrorAlert, showLoadingAlert, handleAjaxError
</script>

<style>
.btn-gradient-primary {
    background: linear-gradient(45deg, #4e73df, #224abe);
    color: white;
    border: none;
}
.pci-indicator {
    transition: all 0.3s ease;
}
.pci-indicator:focus {
    border-color: #4e73df;
    box-shadow: 0 0 0 0.2rem rgba(78, 115, 223, 0.25);
}
.card {
    transition: transform 0.2s ease-in-out;
}
.card:hover {
    transform: translateY(-1px);
}
.badge {
    font-size: 0.75em;
    padding: 0.35em 0.65em;
}
.table th {
    font-weight: 600;
    text-transform: uppercase;
    font-size: 0.8rem;
}
</style>
{% endblock %}