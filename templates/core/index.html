{% extends 'base/web_base.html' %}
{% load humanize %}

{% block content %}
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/waypoints/4.0.1/jquery.waypoints.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Counter-Up/1.0.0/jquery.counterup.min.js"></script>

<!-- ============================================================== -->
<!-- Start Page Content here -->
<!-- ============================================================== -->
<div class="page-content">
    <div class="page-container">
        <!-- Page Title -->
        <div class="page-title-box">
            <div class="d-flex align-items-sm-center flex-sm-row flex-column gap-2">
                <div class="flex-grow-1">
                    <h4 class="font-18 mb-0">Human Rights Monitoring Dashboard</h4>
                </div>
                <div class="text-end">
                    <ol class="breadcrumb m-0 py-0">
                        <li class="breadcrumb-item"><a href="javascript: void(0);">HRM</a></li>
                        <li class="breadcrumb-item active">Child Labor Monitoring</li>
                    </ol>
                </div>
            </div>
        </div>

        <!-- Filter Section -->
        <div class="card mb-3">
            <div class="card-body">
                <form id="dashboardFilters" method="GET">
                    <div class="row">
                        <div class="col-md-2">
                            <div class="mb-3">
                                <label class="form-label">Region</label>
                                <select class="form-select" id="regionFilter" name="regionFilter">
                                    <option value="">All Regions</option>
                                    {% for region in regions %}
                                    <option value="{{ region.region }}" {% if selected_region == region.region %}selected{% endif %}>{{ region.region }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="mb-3">
                                <label class="form-label">District</label>
                                <select class="form-select" id="districtFilter" name="districtFilter">
                                    <option value="">All Districts</option>
                                    {% for district in districts %}
                                    <option value="{{ district }}" {% if selected_district == district %}selected{% endif %}>{{ district }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="mb-3">
                                <label class="form-label">Communities</label>
                                <select class="form-select" id="societyFilter" name="societyFilter">
                                    <option value="">All Communities</option>
                                    {% for society in societies %}
                                    <option value="{{ society }}" {% if selected_society == society %}selected{% endif %}>{{ society }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label class="form-label">Time Period</label>
                                <select class="form-select" id="timeFilter" name="timeFilter">
                                    <option value="7" {% if selected_period == "7" %}selected{% endif %}>Last 7 Days</option>
                                    <option value="30" {% if selected_period == "30" or not selected_period %}selected{% endif %}>Last 30 Days</option>
                                    <option value="90" {% if selected_period == "90" %}selected{% endif %}>Last 90 Days</option>
                                    <option value="365" {% if selected_period == "365" %}selected{% endif %}>Last Year</option>
                                    <option value="custom" {% if selected_period == "custom" %}selected{% endif %}>Custom Range</option>
                                </select>
                            </div>
                            
                            <!-- Custom Date Range Picker -->
                            <div class="mb-3 custom-date-range" style="display: {% if selected_period == 'custom' %}block{% else %}none{% endif %};">
                                <label class="form-label">Custom Date Range</label>
                                <div class="input-group">
                                    <input type="date" class="form-control" id="startDate" name="startDate" placeholder="Start Date" value="{{ start_date }}">
                                    <span class="input-group-text">to</span>
                                    <input type="date" class="form-control" id="endDate" name="endDate" placeholder="End Date" value="{{ end_date }}">
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label class="form-label">&nbsp;</label>
                                <div class="d-flex gap-2">
                                    <button type="submit" class="btn btn-primary w-50">Apply Filters</button>
                                    <button type="button" class="btn btn-outline-secondary w-50" id="resetFilters">Reset</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="row">
            <div class="col-md-6 col-xl-3">
                <div class="card tilebox-one">
                    <div class="card-body">
                        <i class="fas fa-child float-end m-0 h2 text-muted"></i>
                        <h6 class="text-muted text-uppercase mt-0">Children Monitored</h6>
                        <h3 class="my-3 counter-value" data-target="{{ children_monitored }}">{{ children_monitored|intcomma }}</h3>
                        <span class="badge bg-success me-1"> +11% </span> 
                        <span class="text-muted">From last quarter</span>
                    </div>
                </div>
            </div>

            <div class="col-md-6 col-xl-3">
                <div class="card tilebox-one">
                    <div class="card-body">
                        <i class="fas fa-graduation-cap float-end m-0 h2 text-muted"></i>
                        <h6 class="text-muted text-uppercase mt-0">School Enrollment</h6>
                        <h3 class="my-3"><span class="counter-value" data-target="{{ school_enrollment_rate }}">{{ school_enrollment_rate }}</span><small>%</small></h3>
                        <span class="badge bg-success me-1"> +5% </span> 
                        <span class="text-muted">From last year</span>
                    </div>
                </div>
            </div>

            <div class="col-md-6 col-xl-3">
                <div class="card tilebox-one">
                    <div class="card-body">
                        <i class="fas fa-exclamation-triangle float-end m-0 h2 text-muted"></i>
                        <h6 class="text-muted text-uppercase mt-0">At-Risk Cases</h6>
                        <h3 class="my-3 counter-value" data-target="{{ risk_cases }}">{{ risk_cases|intcomma }}</h3>
                        <span class="badge bg-danger me-1"> +8% </span> 
                        <span class="text-muted">From last month</span>
                    </div>
                </div>
            </div>

            <div class="col-md-6 col-xl-3">
                <div class="card tilebox-one">
                    <div class="card-body">
                        <i class="fas fa-hands-helping float-end m-0 h2 text-muted"></i>
                        <h6 class="text-muted text-uppercase mt-0">Interventions</h6>
                        <h3 class="my-3 counter-value" data-target="{{ interventions }}">{{ interventions|intcomma }}</h3>
                        <span class="badge bg-success me-1"> +15% </span> 
                        <span class="text-muted">From last quarter</span>
                    </div>
                </div>
            </div>
        </div> <!-- end row -->

        <!-- Additional Charts Row -->
        <div class="row mt-3">
            <div class="col-lg-6">
                <div class="card card-body">
                    <h4 class="header-title mb-3">Work Type Distribution</h4>
                    <div id="work-type-chart" style="height: 300px;"></div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="card card-body">
                    <h4 class="header-title mb-3">Education Status by Age Group</h4>
                    <div id="education-age-chart" style="height: 300px;"></div>
                </div>
            </div>
        </div>

        <!-- Detailed Metrics Row -->
        <div class="row">
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body text-center">
                        <h6 class="text-muted text-uppercase">Birth Certificates</h6>
                        <h3 class="my-2">{{ birth_cert_rate }}%</h3>
                        <div class="progress mb-2" style="height: 6px;">
                            <div class="progress-bar bg-success" role="progressbar" style="width: {{ birth_cert_rate }}%;" aria-valuenow="{{ birth_cert_rate }}" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                        <p class="mb-0 text-muted">Children with birth certificates</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body text-center">
                        <h6 class="text-muted text-uppercase">Light Work</h6>
                        <h3 class="my-2">{{ light_work_rate }}%</h3>
                        <div class="progress mb-2" style="height: 6px;">
                            <div class="progress-bar bg-warning" role="progressbar" style="width: {{ light_work_rate }}%;" aria-valuenow="{{ light_work_rate }}" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                        <p class="mb-0 text-muted">Children engaged in light work</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body text-center">
                        <h6 class="text-muted text-uppercase">Heavy Work</h6>
                        <h3 class="my-2">{{ heavy_work_rate }}%</h3>
                        <div class="progress mb-2" style="height: 6px;">
                            <div class="progress-bar bg-danger" role="progressbar" style="width: {{ heavy_work_rate }}%;" aria-valuenow="{{ heavy_work_rate }}" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                        <p class="mb-0 text-muted">Children engaged in heavy work</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body text-center">
                        <h6 class="text-muted text-uppercase">Agrochemical Exposure</h6>
                        <h3 class="my-2">{{ agrochemical_rate }}%</h3>
                        <div class="progress mb-2" style="height: 6px;">
                            <div class="progress-bar bg-info" role="progressbar" style="width: {{ agrochemical_rate }}%;" aria-valuenow="{{ agrochemical_rate }}" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                        <p class="mb-0 text-muted">Children exposed to agrochemicals</p>
                    </div>
                </div>
            </div>
        </div> <!-- end row -->

        <!-- Main Charts Row -->
        <div class="row mt-3">
            <div class="col-lg-6 col-xl-8">
                <div class="card card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4 class="header-title mb-0">Child Labor Trends by Region</h4>
                        <div class="btn-group">
                            <button type="button" class="btn btn-sm btn-outline-primary active" data-period="monthly">Monthly</button>
                            <button type="button" class="btn btn-sm btn-outline-primary" data-period="quarterly">Quarterly</button>
                            <button type="button" class="btn btn-sm btn-outline-primary" data-period="yearly">Yearly</button>
                        </div>
                    </div>
                    <div id="labor-trend-chart" style="height: 400px;"></div>
                </div>
            </div><!-- end col-->

            <div class="col-lg-6 col-xl-4">
                <div class="card card-body">
                    <h4 class="header-title mb-3">Risk Classification</h4>
                    <div id="risk-classification-chart" style="height: 400px;"></div>
                </div>
            </div><!-- end col-->
        </div> <!-- end row -->

        <!-- Detailed Data Row -->
        <div class="row mt-3">
            <div class="col-xl-7">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h4 class="header-title mb-3">Recent Monitoring Activities</h4>
                            </div>

                            <div class="activity-widget px-4" data-simplebar style="max-height: 600px;">
                                {% for activity in recent_activities %}
                                <div class="d-flex align-items-center gap-2 py-2 border-bottom">
                                    <div class="activity-icon bg-soft-primary text-primary rounded-circle">
                                        <i class="fas fa-clipboard-check"></i>
                                    </div>
                                    <div class="me-auto">
                                        <p class="text-body mb-0">Household assessment</p>
                                        <p class="text-muted mb-0">{{ activity.farmer.first_name }} {{ activity.farmer.last_name }} - {{ activity.farmer.society_name.districtTbl_foreignkey.regionTbl_foreignkey.region }}</p>
                                    </div>
                                    <p class="font-12 text-body">{{ activity.created_date|timesince }} ago</p>
                                </div>
                                {% empty %}
                                <div class="text-center py-3">
                                    <p class="text-muted">No recent activities</p>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="card card-body">
                            <h4 class="header-title mb-3">Assessment Status</h4>
                            <div class="assessment-status">
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Completed Surveys</span>
                                    <span class="badge bg-success">{{ completed_surveys|intcomma }}</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Pending Review</span>
                                    <span class="badge bg-warning">{{ pending_review|intcomma }}</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Requiring Follow-up</span>
                                    <span class="badge bg-danger">{{ requiring_follow_up|intcomma }}</span>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span>New This Week</span>
                                    <span class="badge bg-info">{{ new_this_week|intcomma }}</span>
                                </div>
                            </div>
                        </div>

                        <div class="card card-body mt-3">
                            <h4 class="header-title mb-3">Regional Distribution</h4>
                            <div class="regional-distribution">
                                {% for region, percentage in regional_distribution.items %}
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span>{{ region }}</span>
                                    <span>{{ percentage }}%</span>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div><!-- end col-->

            <div class="col-xl-5">
                <div class="card card-body">
                    <h4 class="header-title mb-3">Recent Risk Cases</h4>
                    <div class="table-responsive">
                        <table class="table table-bordered table-nowrap mb-0">
                            <thead>
                                <tr>
                                    <th>Case ID</th>
                                    <th>Region</th>
                                    <th>Risk Level</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>yt
                                {% for case in recent_risk_cases %}
                                <tr>
                                    <td>CL-{{ case.assessment_date|date:"Y-m-d" }}-{{ case.child.id }}</td>
                                    <td>{{ case.child.houseHold.farmer.society_name.districtTbl_foreignkey.regionTbl_foreignkey.region }}</td>
                                    <td>
                                        {% if case.risk_level == "no_risk" %}
                                        <span class="badge bg-success">Low</span>
                                        {% elif case.risk_level == "light_risk" %}
                                        <span class="badge bg-warning">Medium</span>
                                        {% elif case.risk_level == "heavy_risk" %}
                                        <span class="badge bg-danger">High</span>
                                        {% elif case.risk_level == "both_risk" %}
                                        <span class="badge bg-danger">Critical</span>
                                        {% endif %}
                                    </td>
                                    <td><span class="badge bg-warning">Under Review</span></td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="4" class="text-center">No risk cases found</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="card card-body mt-3">
                    <h4 class="header-title mb-3">Upcoming Interventions</h4>
                    <div class="upcoming-interventions">
                        {% for intervention in upcoming_interventions %}
                        <div class="d-flex justify-content-between align-items-center mb-3 pb-2 border-bottom">
                            <div>
                                <h6 class="mb-0">{{ intervention.title }}</h6>
                                <small class="text-muted">{{ intervention.assigned_to.first_name }} {{ intervention.assigned_to.last_name }}</small>
                            </div>
                            <span class="badge bg-primary">{{ intervention.end_date|timeuntil }}</span>
                        </div>
                        {% empty %}
                        <div class="text-center py-3">
                            <p class="text-muted">No upcoming interventions</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div><!-- end col-->
        </div> <!-- end row -->

        <!-- Detailed Analytics Section -->
        <div class="row mt-3">
            <div class="col-lg-12">
                <div class="card">
                    <div class="card-header">
                        <h4 class="header-title">Detailed Child Labor Analysis</h4>
                    </div>
                    <div class="card-body">
                        <ul class="nav nav-tabs nav-bordered">
                            <li class="nav-item">
                                <a href="#demographics-tab" data-bs-toggle="tab" aria-expanded="false" class="nav-link active">
                                    Demographics
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="#education-tab" data-bs-toggle="tab" aria-expanded="true" class="nav-link">
                                    Education
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="#work-tab" data-bs-toggle="tab" aria-expanded="false" class="nav-link">
                                    Work Patterns
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="#risk-tab" data-bs-toggle="tab" aria-expanded="false" class="nav-link">
                                    Risk Factors
                                </a>
                            </li>
                        </ul>
                        <div class="tab-content">
                            <div class="tab-pane show active" id="demographics-tab">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h5>Age Distribution</h5>
                                        <div id="age-distribution-chart" style="height: 250px;"></div>
                                    </div>
                                    <div class="col-md-6">
                                        <h5>Gender Distribution by Region</h5>
                                        <div id="gender-region-chart" style="height: 250px;"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="tab-pane" id="education-tab">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h5>School Attendance by Age</h5>
                                        <div id="school-attendance-chart" style="height: 250px;"></div>
                                    </div>
                                    <div class="col-md-6">
                                        <h5>Literacy Levels</h5>
                                        <div id="literacy-levels-chart" style="height: 250px;"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="tab-pane" id="work-tab">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h5>Work Hours by Age Group</h5>
                                        <div id="work-hours-chart" style="height: 250px;"></div>
                                    </div>
                                    <div class="col-md-6">
                                        <h5>Task Types Distribution</h5>
                                        <div id="task-types-chart" style="height: 250px;"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="tab-pane" id="risk-tab">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h5>Risk Factors Correlation</h5>
                                        <div id="risk-correlation-chart" style="height: 250px;"></div>
                                    </div>
                                    <div class="col-md-6">
                                        <h5>Intervention Effectiveness</h5>
                                        <div id="intervention-effectiveness-detailed-chart" style="height: 250px;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Tables Section -->
        <div class="row mt-3">
            <div class="col-lg-12">
                <div class="card">
                    <div class="card-header">
                        <h4 class="header-title">Child Labor Cases Overview</h4>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-centered table-nowrap mb-0">
                                <thead>
                                    <tr>
                                        <th>Case ID</th>
                                        <th>Child Name</th>
                                        <th>Age</th>
                                        <th>Region</th>
                                        <th>Risk Level</th>
                                        <th>School Status</th>
                                        <th>Work Hours</th>
                                        <th>Last Assessment</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for case in child_labor_cases %}
                                    <tr>
                                        <td>{{ case.case_id }}</td>
                                        <td>{{ case.child_name }}</td>
                                        <td>{{ case.age }}</td>
                                        <td>{{ case.region }}</td>
                                        <td>
                                            {% if case.risk_level == "Low Risk" %}
                                            <span class="badge bg-success">Low</span>
                                            {% elif case.risk_level == "Medium Risk" %}
                                            <span class="badge bg-warning">Medium</span>
                                            {% elif case.risk_level == "High Risk" %}
                                            <span class="badge bg-danger">High</span>
                                            {% elif case.risk_level == "Critical Risk" %}
                                            <span class="badge bg-danger">Critical</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ case.school_status }}</td>
                                        <td>{{ case.work_hours }} hrs/week</td>
                                        <td>{{ case.last_assessment }}</td>
                                        <td>
                                            <button class="btn btn-sm btn-primary">View</button>
                                            <button class="btn btn-sm btn-info">Intervene</button>
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="9" class="text-center">No child labor cases found</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Analytics Section -->
        <div class="row mt-3">
            <div class="col-md-6 col-xl-4">
                <div class="card card-body">
                    <h4 class="header-title mb-3">Child Demographics</h4>
                    <div id="child-demographics-chart" style="height: 300px;"></div>
                </div>
            </div>
            
            <div class="col-md-6 col-xl-4">
                <div class="card card-body">
                    <h4 class="header-title mb-3">Education Status</h4>
                    <div id="education-status-chart" style="height: 300px;"></div>
                </div>
            </div>
            
            <div class="col-md-6 col-xl-4">
                <div class="card card-body">
                    <h4 class="header-title mb-3">Work Types Analysis</h4>
                    <div id="work-types-chart" style="height: 300px;"></div>
                </div>
            </div>
        </div>
    </div> <!-- container -->
</div>

<!-- ============================================================== -->
<!-- End Page content -->
<!-- ============================================================== -->

<script>
    // Data from Django context
    const dashboardData = {
        childrenMonitored: {{ children_monitored }},
        schoolEnrollmentRate: {{ school_enrollment_rate }},
        riskCases: {{ risk_cases }},
        interventions: {{ interventions }},
        birthCertRate: {{ birth_cert_rate }},
        lightWorkRate: {{ light_work_rate }},
        heavyWorkRate: {{ heavy_work_rate }},
        agrochemicalRate: {{ agrochemical_rate }},
        monthlyTrends: {{ monthly_trends|safe }},
        riskData: {{ risk_data|safe }},
        educationByAge: {{ education_by_age|safe }},
        workTypes: {{ work_types|safe }},
        ageDistribution: {{ age_distribution|safe }},
        genderRegionData: {{ gender_region_data|safe }},
        schoolAttendance: {{ school_attendance|safe }},
        literacyLevels: {{ literacy_levels|safe }},
        workHoursByAge: {{ work_hours_by_age|safe }},
        taskTypes: {{ task_types|safe }},
        riskCorrelation: {{ risk_correlation|safe }},
        effectivenessRate: {{ effectiveness_rate }},
        lightTasks: {{ light_tasks|safe }},
        heavyTasks: {{ heavy_tasks|safe }},
        educationStatus: {{ education_status|safe }},
        childDemographics: {{ child_demographics|safe }}
    };

    console.log('Dashboard Data:', dashboardData);

    $(document).ready(function() {
        // Initialize counter animation
        $('.counter-value').counterUp({
            delay: 10,
            time: 1000
        });

        // Show/hide custom date range based on selection
        $('#timeFilter').on('change', function() {
            if ($(this).val() === 'custom') {
                $('.custom-date-range').show();
            } else {
                $('.custom-date-range').hide();
            }
        });

        // Reset filters
        $('#resetFilters').on('click', function() {
            $('#dashboardFilters')[0].reset();
            window.location.search = '';
        });

        // Auto-submit form when filters change (except for custom date inputs)
        $('#regionFilter, #districtFilter, #societyFilter, #timeFilter').on('change', function() {
            if ($('#timeFilter').val() !== 'custom') {
                $('#dashboardFilters').submit();
            }
        });

        // Auto-submit when custom dates are selected
        $('#startDate, #endDate').on('change', function() {
            if ($('#timeFilter').val() === 'custom') {
                $('#dashboardFilters').submit();
            }
        });

        // Load districts based on selected region
        $('#regionFilter').on('change', function() {
            const region = $(this).val();
            if (region) {
                // This would typically be an AJAX call to fetch districts
                // For now, we'll just submit the form to reload with the region filter
                $('#dashboardFilters').submit();
            } else {
                $('#districtFilter').val('');
            }
        });

        // Load societies based on selected district
        $('#districtFilter').on('change', function() {
            const district = $(this).val();
            if (district) {
                $('#dashboardFilters').submit();
            } else {
                $('#societyFilter').val('');
            }
        });

        // Chart period toggle
        $('[data-period]').on('click', function() {
            $('[data-period]').removeClass('active');
            $(this).addClass('active');
            const period = $(this).data('period');
            updateChartPeriod(period);
        });
    });

    document.addEventListener('DOMContentLoaded', function() {
        // Initialize all charts with real data
        initLaborTrendChart();
        initRiskClassificationChart();
        initWorkTypeChart();
        initEducationAgeChart();
        initChildDemographicsChart();
        initEducationStatusChart();
        initWorkTypesChart();
        initAgeDistributionChart();
        initGenderRegionChart();
        initSchoolAttendanceChart();
        initLiteracyLevelsChart();
        initWorkHoursChart();
        initTaskTypesChart();
        initRiskCorrelationChart();
        initInterventionEffectivenessDetailedChart();

        // Resize charts on window resize
        window.addEventListener('resize', function() {
            laborTrendChart.resize();
            riskClassificationChart.resize();
            workTypeChart.resize();
            educationAgeChart.resize();
            childDemographicsChart.resize();
            educationStatusChart.resize();
            workTypesChart.resize();
            ageDistributionChart.resize();
            genderRegionChart.resize();
            schoolAttendanceChart.resize();
            literacyLevelsChart.resize();
            workHoursChart.resize();
            taskTypesChart.resize();
            riskCorrelationChart.resize();
            interventionEffectivenessDetailedChart.resize();
        });
    });

    // Chart instances
    let laborTrendChart, riskClassificationChart;
    let workTypeChart, educationAgeChart;
    let childDemographicsChart, educationStatusChart, workTypesChart;
    let ageDistributionChart, genderRegionChart, schoolAttendanceChart;
    let literacyLevelsChart, workHoursChart, taskTypesChart;
    let riskCorrelationChart, interventionEffectivenessDetailedChart;

    function initLaborTrendChart() {
        laborTrendChart = echarts.init(document.getElementById('labor-trend-chart'));
        
        const regionNames = dashboardData.monthlyTrends.map(item => item.name);
        const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        const seriesData = dashboardData.monthlyTrends.map(region => ({
            name: region.name,
            type: 'bar',
            data: region.data,
            itemStyle: { color: getRandomColor() }
        }));
        
        const option = {
            tooltip: {
                trigger: 'axis',
                formatter: function(params) {
                    let result = `<div style="font-weight:bold;margin-bottom:5px">${params[0].axisValue}</div>`;
                    params.forEach(item => {
                        result += `
                        <div style="display:flex;align-items:center;margin:5px 0">
                            <span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:${item.color};margin-right:5px"></span>
                            ${item.seriesName}: <strong>${item.value} cases</strong>
                        </div>`;
                    });
                    return result;
                }
            },
            legend: {
                data: regionNames,
                type: 'scroll',
                orient: 'horizontal',
                bottom: 0,
                selectedMode: 'multiple',
                textStyle: {
                    fontSize: 12
                }
            },
            xAxis: {
                type: 'category',
                data: monthNames.slice(0, dashboardData.monthlyTrends[0]?.data.length || 12),
                axisLine: {
                    lineStyle: {
                        color: '#999'
                    }
                },
                axisLabel: {
                    color: '#666',
                    interval: 0,
                    rotate: 45
                },
                axisTick: {
                    alignWithLabel: true
                }
            },
            yAxis: {
                type: 'value',
                name: 'Cases Reported',
                nameLocation: 'middle',
                nameGap: 40,
                nameTextStyle: {
                    fontSize: 14,
                    fontWeight: 'bold'
                },
                axisLine: {
                    show: true,
                    lineStyle: {
                        color: '#999'
                    }
                },
                axisLabel: {
                    formatter: '{value}',
                    color: '#666'
                }
            },
            series: seriesData,
            animation: true,
            animationDuration: 1500,
            animationEasing: 'cubicInOut'
        };
        laborTrendChart.setOption(option);
    }

    function initRiskClassificationChart() {
        riskClassificationChart = echarts.init(document.getElementById('risk-classification-chart'));
        const option = {
            tooltip: {
                trigger: 'item'
            },
            legend: {
                orient: 'vertical',
                right: 10,
                top: 'center',
                data: ['No Risk', 'Light Risk', 'Heavy Risk', 'Both Risk']
            },
            series: [
                {
                    name: 'Risk Classification',
                    type: 'pie',
                    radius: ['40%', '70%'],
                    avoidLabelOverlap: false,
                    itemStyle: {
                        borderRadius: 10,
                        borderColor: '#fff',
                        borderWidth: 2
                    },
                    label: {
                        show: false,
                        position: 'center'
                    },
                    emphasis: {
                        label: {
                            show: true,
                            fontSize: '18',
                            fontWeight: 'bold'
                        }
                    },
                    labelLine: {
                        show: false
                    },
                    data: [
                        { value: dashboardData.riskData.no_risk, name: 'No Risk', itemStyle: { color: '#1abc9c' } },
                        { value: dashboardData.riskData.light_risk, name: 'Light Risk', itemStyle: { color: '#f7b84b' } },
                        { value: dashboardData.riskData.heavy_risk, name: 'Heavy Risk', itemStyle: { color: '#e83e8c' } },
                        { value: dashboardData.riskData.both_risk, name: 'Both Risk', itemStyle: { color: '#f1556c' } }
                    ]
                }
            ]
        };
        riskClassificationChart.setOption(option);
    }

    function initWorkTypeChart() {
        workTypeChart = echarts.init(document.getElementById('work-type-chart'));
        
        const lightTaskData = dashboardData.lightTasks.map(task => ({
            name: task.task__name,
            value: task.count
        }));
        
        const heavyTaskData = dashboardData.heavyTasks.map(task => ({
            name: task.task__name,
            value: task.count
        }));
        
        // Combine light and heavy tasks
        const allTasks = [...lightTaskData, ...heavyTaskData];
        
        const option = {
            tooltip: {
                trigger: 'item'
            },
            legend: {
                orient: 'horizontal',
                bottom: 0
            },
            series: [
                {
                    name: 'Work Type',
                    type: 'pie',
                    radius: '70%',
                    data: allTasks.map((task, index) => ({
                        value: task.value,
                        name: task.name,
                        itemStyle: { color: getRandomColor(index) }
                    })),
                    emphasis: {
                        itemStyle: {
                            shadowBlur: 10,
                            shadowOffsetX: 0,
                            shadowColor: 'rgba(0, 0, 0, 0.5)'
                        }
                    }
                }
            ]
        };
        workTypeChart.setOption(option);
    }

    function initEducationAgeChart() {
        educationAgeChart = echarts.init(document.getElementById('education-age-chart'));
        
        const ageGroups = Object.keys(dashboardData.educationByAge);
        const enrolledData = ageGroups.map(group => dashboardData.educationByAge[group].enrolled);
        const notEnrolledData = ageGroups.map(group => dashboardData.educationByAge[group].not_enrolled);
        
        const option = {
            tooltip: {
                trigger: 'axis'
            },
            legend: {
                data: ['Enrolled', 'Not Enrolled']
            },
            xAxis: {
                type: 'category',
                data: ageGroups
            },
            yAxis: {
                type: 'value',
                name: 'Number of Children'
            },
            series: [
                {
                    name: 'Enrolled',
                    type: 'bar',
                    data: enrolledData,
                    itemStyle: { color: '#1abc9c' }
                },
                {
                    name: 'Not Enrolled',
                    type: 'bar',
                    data: notEnrolledData,
                    itemStyle: { color: '#e83e8c' }
                }
            ]
        };
        educationAgeChart.setOption(option);
    }

    function initChildDemographicsChart() {
        childDemographicsChart = echarts.init(document.getElementById('child-demographics-chart'));
        
        // Group ages into categories
        const ageGroups = {
            '5-9 years': 0,
            '10-14 years': 0,
            '15-17 years': 0
        };
        
        dashboardData.childDemographics.forEach(item => {
            if (item.age >= 5 && item.age <= 9) {
                ageGroups['5-9 years'] += item.count;
            } else if (item.age >= 10 && item.age <= 14) {
                ageGroups['10-14 years'] += item.count;
            } else if (item.age >= 15 && item.age <= 17) {
                ageGroups['15-17 years'] += item.count;
            }
        });
        
        const option = {
            tooltip: {
                trigger: 'item',
                formatter: '{a} <br/>{b}: {c} ({d}%)'
            },
            legend: {
                orient: 'vertical',
                right: 10,
                top: 'center',
                data: Object.keys(ageGroups)
            },
            series: [{
                name: 'Age Groups',
                type: 'pie',
                radius: ['50%', '70%'],
                avoidLabelOverlap: false,
                label: {
                    show: false,
                    position: 'center'
                },
                emphasis: {
                    label: {
                        show: true,
                        fontSize: '18',
                        fontWeight: 'bold'
                    }
                },
                labelLine: {
                    show: false
                },
                data: [
                    {value: ageGroups['5-9 years'], name: '5-9 years', itemStyle: {color: '#1abc9c'}},
                    {value: ageGroups['10-14 years'], name: '10-14 years', itemStyle: {color: '#3498db'}},
                    {value: ageGroups['15-17 years'], name: '15-17 years', itemStyle: {color: '#9b59b6'}}
                ]
            }]
        };
        childDemographicsChart.setOption(option);
    }

    function initEducationStatusChart() {
        educationStatusChart = echarts.init(document.getElementById('education-status-chart'));
        
        const option = {
            tooltip: {
                trigger: 'axis',
                axisPointer: {
                    type: 'shadow'
                }
            },
            grid: {
                left: '3%',
                right: '4%',
                bottom: '3%',
                containLabel: true
            },
            xAxis: {
                type: 'category',
                data: ['Enrolled', 'Not Enrolled', 'Dropout', 'Never Attended']
            },
            yAxis: {
                type: 'value',
                name: 'Number of Children'
            },
            series: [{
                name: 'Education Status',
                type: 'bar',
                data: [
                    dashboardData.educationStatus.enrolled,
                    dashboardData.educationStatus.not_enrolled,
                    dashboardData.educationStatus.dropout,
                    dashboardData.educationStatus.never_attended
                ],
                itemStyle: {
                    color: function(params) {
                        var colorList = ['#1abc9c', '#e74c3c', '#f39c12', '#95a5a6'];
                        return colorList[params.dataIndex];
                    }
                },
                label: {
                    show: true,
                    position: 'top'
                }
            }]
        };
        educationStatusChart.setOption(option);
    }

    function initWorkTypesChart() {
        workTypesChart = echarts.init(document.getElementById('work-types-chart'));
        
        const option = {
            tooltip: {
                trigger: 'item',
                formatter: '{a} <br/>{b}: {c} ({d}%)'
            },
            legend: {
                orient: 'vertical',
                right: 10,
                top: 'center',
                data: ['Light Work', 'Heavy Work', 'Hazardous', 'Domestic']
            },
            series: [{
                name: 'Work Types',
                type: 'pie',
                radius: ['50%', '70%'],
                avoidLabelOverlap: false,
                label: {
                    show: false,
                    position: 'center'
                },
                emphasis: {
                    label: {
                        show: true,
                        fontSize: '14',
                        fontWeight: 'bold'
                    }
                },
                labelLine: {
                    show: false
                },
                data: [
                    {value: dashboardData.workTypes.light_work, name: 'Light Work', itemStyle: {color: '#1abc9c'}},
                    {value: dashboardData.workTypes.heavy_work, name: 'Heavy Work', itemStyle: {color: '#f39c12'}},
                    {value: dashboardData.workTypes.hazardous, name: 'Hazardous', itemStyle: {color: '#e74c3c'}},
                    {value: dashboardData.workTypes.domestic, name: 'Domestic', itemStyle: {color: '#3498db'}}
                ]
            }]
        };
        workTypesChart.setOption(option);
    }

    function initAgeDistributionChart() {
        ageDistributionChart = echarts.init(document.getElementById('age-distribution-chart'));
        
        const ages = Object.keys(dashboardData.ageDistribution);
        const counts = Object.values(dashboardData.ageDistribution);
        
        const option = {
            tooltip: {
                trigger: 'axis',
                axisPointer: {
                    type: 'shadow'
                }
            },
            grid: {
                left: '3%',
                right: '4%',
                bottom: '3%',
                containLabel: true
            },
            xAxis: {
                type: 'category',
                data: ages
            },
            yAxis: {
                type: 'value',
                name: 'Number of Children'
            },
            series: [{
                name: 'Children',
                type: 'bar',
                data: counts,
                itemStyle: {
                    color: '#3498db'
                }
            }]
        };
        ageDistributionChart.setOption(option);
    }

    function initGenderRegionChart() {
        genderRegionChart = echarts.init(document.getElementById('gender-region-chart'));
        
        const regions = Object.keys(dashboardData.genderRegionData);
        const maleData = regions.map(region => dashboardData.genderRegionData[region].male);
        const femaleData = regions.map(region => dashboardData.genderRegionData[region].female);
        
        const option = {
            tooltip: {
                trigger: 'axis'
            },
            legend: {
                data: ['Boys', 'Girls']
            },
            xAxis: {
                type: 'category',
                data: regions
            },
            yAxis: {
                type: 'value',
                name: 'Number of Children'
            },
            series: [
                {
                    name: 'Boys',
                    type: 'bar',
                    data: maleData,
                    itemStyle: {color: '#3498db'}
                },
                {
                    name: 'Girls',
                    type: 'bar',
                    data: femaleData,
                    itemStyle: {color: '#e83e8c'}
                }
            ]
        };
        genderRegionChart.setOption(option);
    }

    function initSchoolAttendanceChart() {
        schoolAttendanceChart = echarts.init(document.getElementById('school-attendance-chart'));
        
        const ageGroups = Object.keys(dashboardData.schoolAttendance);
        const attendanceRates = Object.values(dashboardData.schoolAttendance);
        
        const option = {
            tooltip: {
                trigger: 'axis'
            },
            xAxis: {
                type: 'category',
                data: ageGroups
            },
            yAxis: {
                type: 'value',
                name: 'Percentage'
            },
            series: [{
                name: 'Attendance Rate',
                type: 'line',
                data: attendanceRates,
                smooth: true,
                lineStyle: {
                    width: 3,
                    color: '#1abc9c'
                },
                itemStyle: {
                    color: '#1abc9c'
                }
            }]
        };
        schoolAttendanceChart.setOption(option);
    }

    function initLiteracyLevelsChart() {
        literacyLevelsChart = echarts.init(document.getElementById('literacy-levels-chart'));
        
        const option = {
            tooltip: {
                trigger: 'axis'
            },
            xAxis: {
                type: 'category',
                data: ['Basic', 'Intermediate', 'Advanced', 'Illiterate']
            },
            yAxis: {
                type: 'value',
                name: 'Percentage'
            },
            series: [{
                name: 'Literacy Levels',
                type: 'bar',
                data: [
                    dashboardData.literacyLevels.basic,
                    dashboardData.literacyLevels.intermediate,
                    dashboardData.literacyLevels.advanced,
                    dashboardData.literacyLevels.illiterate
                ],
                itemStyle: {
                    color: function(params) {
                        var colorList = ['#1abc9c', '#3498db', '#9b59b6', '#e74c3c'];
                        return colorList[params.dataIndex];
                    }
                }
            }]
        };
        literacyLevelsChart.setOption(option);
    }

    function initWorkHoursChart() {
        workHoursChart = echarts.init(document.getElementById('work-hours-chart'));
        
        const ageGroups = Object.keys(dashboardData.workHoursByAge);
        const workHours = Object.values(dashboardData.workHoursByAge);
        
        const option = {
            tooltip: {
                trigger: 'axis'
            },
            xAxis: {
                type: 'category',
                data: ageGroups
            },
            yAxis: {
                type: 'value',
                name: 'Hours/Week'
            },
            series: [{
                name: 'Work Hours',
                type: 'bar',
                data: workHours,
                itemStyle: {
                    color: '#f39c12'
                }
            }]
        };
        workHoursChart.setOption(option);
    }

    function initTaskTypesChart() {
        taskTypesChart = echarts.init(document.getElementById('task-types-chart'));
        
        const taskNames = Object.keys(dashboardData.taskTypes);
        const taskCounts = Object.values(dashboardData.taskTypes);
        
        const option = {
            tooltip: {
                trigger: 'item',
                formatter: '{a} <br/>{b}: {c} ({d}%)'
            },
            legend: {
                orient: 'vertical',
                right: 10,
                top: 'center'
            },
            series: [{
                name: 'Task Types',
                type: 'pie',
                radius: '70%',
                data: taskNames.map((name, index) => ({
                    value: taskCounts[index],
                    name: name,
                    itemStyle: { color: getRandomColor(index) }
                }))
            }]
        };
        taskTypesChart.setOption(option);
    }

    function initRiskCorrelationChart() {
        riskCorrelationChart = echarts.init(document.getElementById('risk-correlation-chart'));
        
        const option = {
            tooltip: {
                trigger: 'axis'
            },
            radar: {
                indicator: [
                    {name: 'Poverty', max: 100},
                    {name: 'Education', max: 100},
                    {name: 'Family Size', max: 100},
                    {name: 'Work Hours', max: 100},
                    {name: 'Region', max: 100}
                ]
            },
            series: [{
                name: 'Risk Correlation',
                type: 'radar',
                data: [
                    {
                        value: [
                            dashboardData.riskCorrelation.poverty,
                            dashboardData.riskCorrelation.education,
                            dashboardData.riskCorrelation.family_size,
                            dashboardData.riskCorrelation.work_hours,
                            dashboardData.riskCorrelation.region
                        ],
                        name: 'Risk Factors',
                        itemStyle: {color: '#e74c3c'}
                    }
                ]
            }]
        };
        riskCorrelationChart.setOption(option);
    }

    function initInterventionEffectivenessDetailedChart() {
        interventionEffectivenessDetailedChart = echarts.init(document.getElementById('intervention-effectiveness-detailed-chart'));
        
        const option = {
            tooltip: {
                trigger: 'axis'
            },
            xAxis: {
                type: 'category',
                data: ['Q1', 'Q2', 'Q3', 'Q4']
            },
            yAxis: {
                type: 'value',
                name: 'Success Rate (%)'
            },
            series: [{
                name: 'Intervention Effectiveness',
                type: 'line',
                data: [65, 70, 75, dashboardData.effectivenessRate],
                smooth: true,
                lineStyle: {color: '#1abc9c'},
                itemStyle: {color: '#1abc9c'}
            }]
        };
        interventionEffectivenessDetailedChart.setOption(option);
    }

    function updateChartPeriod(period) {
        // In a real application, you would fetch new data based on the period
        console.log('Updating charts for period:', period);
        
        // For now, we'll just reload the page with the new period parameter
        let urlParams = new URLSearchParams(window.location.search);
        urlParams.set('timeFilter', period);
        window.location.search = urlParams.toString();
    }

    // Helper function to generate random colors
    function getRandomColor(index = null) {
        const colors = [
            '#3bafda', '#1abc9c', '#f7b84b', '#e83e8c', '#6c757d',
            '#3498db', '#2ecc71', '#f1c40f', '#e74c3c', '#95a5a6',
            '#9b59b6', '#16a085', '#27ae60', '#d35400', '#c0392b'
        ];
        
        if (index !== null) {
            return colors[index % colors.length];
        }
        
        return colors[Math.floor(Math.random() * colors.length)];
    }
</script>

{% endblock %}